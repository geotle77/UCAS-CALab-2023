diff --git a/EXEstage.v b/EXEstage.v
index 793834c..e36723d 100644
--- a/EXEstage.v
+++ b/EXEstage.v
@@ -100,7 +100,7 @@ wire                          es_gr_we;
 wire [4:0]                    es_dest;
 wire [`DS_EXC_DATA_WD-1 : 0]  ds_exc_data;
 wire [1:0]                    es_time_op;
-assign {es_refetch_flg,
+assign {es_refetch_flg_inst,
         es_invtlb_op,
         es_inst_tlbsrch,
         es_inst_tlbrd,
@@ -122,6 +122,8 @@ assign {es_refetch_flg,
         ds_exc_data,
         es_time_op
         } = ds2es_bus_reg;
+wire es_refetch_flg_inst;
+assign es_refetch_flg = es_refetch_flg_inst && es_valid;
 
 
 
@@ -279,7 +281,7 @@ always @(posedge clk) begin
     if (reset) begin
         es_valid <= 1'b0;
     end 
-    else if(es_reflush) begin
+    else if(es_reflush || es_refetch_flg) begin
         es_valid <= 1'b0;
     end else if (es_allowin) begin
         es_valid <= ds2es_valid;
diff --git a/IDstage.v b/IDstage.v
index 90a43c9..6e116ce 100644
--- a/IDstage.v
+++ b/IDstage.v
@@ -64,7 +64,7 @@ assign {ds_adef, ds_wrong_addr} = fs_exc_data;
 // fs to ds bus
 reg [`FS2DS_BUS_LEN-1: 0] fs2ds_bus_reg;
 always @(posedge clk) begin
-    if (reset || ds_reflush) begin
+    if (reset || ds_reflush || ds_refetch_flg) begin
       ds_valid <= 1'b0;
     end else if (ds_allowin) begin
       ds_valid <= fs2ds_valid;
@@ -593,8 +593,9 @@ wire [3:0]  ds_csr_op;
 assign ds_csr_op = {inst_rdcntid, inst_csrxchg, inst_csrwr, inst_csrrd};
 //TODO:why we need refetch in these cases?
 /*These instructions block whenever they occur, regardless of whether or not they are write-after-read related.*/
-assign ds_refetch_flg = inst_tlbfill || inst_tlbwr || inst_tlbrd || inst_invtlb ||
-                        (ds_csr_we) && (ds_csr_num == `CSR_CRMD || ds_csr_num == `CSR_ASID);
+assign ds_refetch_flg = ds_valid &&
+                        (inst_tlbfill || inst_tlbwr || inst_tlbrd || inst_invtlb ||
+                        (ds_csr_we) && (ds_csr_num == `CSR_CRMD || ds_csr_num == `CSR_ASID));
 assign invtlb_op = rd;
 
 endmodule
\ No newline at end of file
diff --git a/IFstage.v b/IFstage.v
index 78cacf0..4ec658f 100644
--- a/IFstage.v
+++ b/IFstage.v
@@ -38,7 +38,10 @@ module IFstage (
     input wire  [9:0]                 mmu_asid,
     // to tlb
     output wire [19:0]                s0_va_highbits,
-    output wire [ 9:0]                s0_asid
+    output wire [ 9:0]                s0_asid,
+
+    //Icache
+    output wire [31:0]                inst_addr_vrtl
 );
 
 
@@ -77,6 +80,9 @@ reg fs_br_stall;
 wire [5:0] fs_exc_ecode;
 assign {br_stall, br_taken, br_target} = br_zip;
 
+//icache
+assign inst_addr_vrtl = nextpc;
+
 //------------------pre-IF stage------------------
 
 always @(posedge clk) begin
@@ -89,9 +95,9 @@ always @(posedge clk) begin
 end
 
 assign to_fs_valid = pfs_valid && pfs_ready_go;
-assign pfs_ready_go = inst_sram_en && inst_sram_addr_ok && ~(pfs_reflush | fs_reflush | br_taken &~br_stall | br_stall);//the addr is accepted then enter IF stage//my
+assign pfs_ready_go = inst_sram_en && inst_sram_addr_ok && ~(fs_reflush | br_taken &~br_stall | br_stall);//pfs_reflush | the addr is accepted then enter IF stage//my
 
-assign inst_sram_en       = fs_allowin & pfs_valid & ~pfs_reflush; // consider the case if pfs_valid :1 but fs_allowin :0//my
+assign inst_sram_en       = fs_allowin & pfs_valid ;//& ~pfs_reflush; // consider the case if pfs_valid :1 but fs_allowin :0//my
 //simple solution : fs_allowin =1 then inst_sram_en =1 to avoid the pfs_ready_go =1 but fs_allowin =0,which can't keep the inst
 //this method is not good, because it arise more delay
 assign inst_sram_wr       = 1'b0;
@@ -135,6 +141,9 @@ always @(posedge clk) begin
   else if (fs_allowin) begin
     fs_valid <= to_fs_valid & ~fs_reflush;
   end
+  else if(fs_inst_cancel)
+    fs_valid <= 1'b0;
+  
 end
 
 assign fs_ready_go = fs_valid && inst_sram_data_ok || fs_inst_valid && ~fs_inst_cancel;//consider two cases: 1. the inst is from the sram 2. the inst is from the inst_buf
@@ -159,6 +168,7 @@ assign fs_exc_data    = {fs_valid & fs_adef, // 32:32
 
 
 
+
 assign seq_pc = fs_pc + 3'h4;
 assign nextpc  =  wb_ex? csr_ex_entry:   //the nextpc is updated in these cases
                   fs_ex_valid? fs_ex_entry:
@@ -173,15 +183,16 @@ always @(posedge clk) begin
     fs_ex_valid <= 1'b0;
     fs_ertn_entry <= 32'b0;
     fs_ex_entry <= 32'b0;
+  end  
+  else if(wb_ex) begin
+    fs_ex_valid <= wb_ex;
+    fs_ex_entry <= csr_ex_entry;
   end
   else if(ertn_flush) begin
     fs_ertn_valid <= ertn_flush;
     fs_ertn_entry <= csr_ertn_entry;
   end
-  else if(wb_ex) begin
-    fs_ex_valid <= wb_ex;
-    fs_ex_entry <= csr_ex_entry;
-  end
+
 end
 
 always @(posedge clk) begin
diff --git a/MEMstage.v b/MEMstage.v
index 25ec901..70c52a5 100644
--- a/MEMstage.v
+++ b/MEMstage.v
@@ -62,7 +62,7 @@ wire [`MS_EXC_DATA_WD-1 : 0] mem_exc_data;
 reg[`ES2MS_BUS_LEN-1:0] es2ms_bus_reg;
 assign {ms_adem,
         ms_exc_ecode,
-        ms_refetch_flg,
+        ms_refetch_flg_inst,
         ms_inst_tlbsrch,
         ms_inst_tlbrd,
         ms_inst_tlbwr,
@@ -81,6 +81,8 @@ assign {ms_adem,
         mem_rkd_value,
         mem_exc_data
         } = es2ms_bus_reg;
+wire ms_refetch_flg_inst;
+assign ms_refetch_flg = ms_refetch_flg_inst && ms_valid;
 
 wire        mem_rf_we;
 wire [31:0] mem_final_result;
@@ -131,7 +133,7 @@ always @(posedge clk) begin
   if (reset) begin
     ms_valid <= 1'b0;
   end 
-  if (ms_reflush) begin
+  if (ms_reflush || ms_refetch_flg) begin
     ms_valid <= 1'b0;
   end
   else if (ms_allowin) begin
diff --git a/MMU.v b/MMU.v
index bdf065c..6afb33a 100644
--- a/MMU.v
+++ b/MMU.v
@@ -18,12 +18,12 @@ module MMU(
     input  wire                       s_v, 
 
     //interface 
-    input wire [31:0]                 va,
-    output wire [5:0]                 exc_ecode,
-    output wire                       dmw_hit,
-    output wire [ 1:0]                plv,//10:adef,01:adem
-    output wire [31:0]                pa,
-    output wire [ 9:0]                s_asid
+    input wire [31:0]                va,
+    output wire [5:0]                exc_ecode,
+    output wire                      dmw_hit,
+    output wire [ 1:0]               plv,//10:adef,01:adem
+    output wire [31:0]               pa,
+    output wire [ 9:0]               s_asid
 );
 
 
@@ -75,7 +75,7 @@ and then translated according to the page table mapping model after that.
 */
 assign tlb_trans = ~dmw_hit0 & ~dmw_hit1 & ~direct;
 
-assign ecode_pif = flag[1] & tlb_trans & ~s_v;//only in IF stage
+assign ecode_pif = tlb_trans & ~s_v;
 assign ecode_ppi = tlb_trans & ((csr_crmd_plv > s_plv));//
 assign ecode_tlbr = tlb_trans & ~s_found;
 assign ecode_pil = flag[1]?1'b0:tlb_trans & ~s_v;
diff --git a/WBstage.v b/WBstage.v
index 11b1495..1653975 100644
--- a/WBstage.v
+++ b/WBstage.v
@@ -27,7 +27,10 @@ module WBstage (
     output wire [4:0]                   debug_wb_rf_wnum  ,
     output wire [31:0]                  debug_wb_rf_wdata ,
     
-    output wire                         ws_csr_tlbrd
+    output wire                         ws_csr_tlbrd,
+    
+    output wire ws_refetch_flush,
+    output wire [31:0] ws_pc
 
 );
 
@@ -42,7 +45,7 @@ wire          ws_inst_tlbfill;
 wire          ws_tlbsrch_hit;
 wire [ 3:0]   ws_tlbsrch_hit_index;
 wire [ 5:0]   ws_exc_ecode;
-wire [31:0]   ws_pc;
+//wire [31:0]   ws_pc;
 wire          ws_gr_we;
 wire [4:0]    ws_dest;
 wire [31:0]   ws_final_result;
@@ -50,7 +53,7 @@ wire [31: 0]  ws_rkd_value;
 wire [`MS_EXC_DATA_WD -1 : 0] ws_exc_data;
 reg  [`MS2WS_BUS_LEN -1 : 0]  ms2ws_bus_reg;
 assign {ws_exc_ecode,
-        ws_refetch_flg,
+        ws_refetch_flg_inst,
         ws_inst_tlbsrch,
         ws_inst_tlbrd,
         ws_inst_tlbwr,
@@ -64,6 +67,8 @@ assign {ws_exc_ecode,
         ws_rkd_value, 
         ws_exc_data
         } = ms2ws_bus_reg;
+wire ws_refetch_flg_inst;
+assign ws_refetch_flg = ws_refetch_flg_inst && ws_valid;
 
 assign {
         ws_csr_op,
@@ -145,7 +150,7 @@ always @(posedge clk) begin
     if (reset) begin
         ws_valid <= 1'b0;
     end 
-    else if (ws_ex | ws_ertn_flush) begin
+    else if (ws_ex | ws_ertn_flush | ws_refetch_flg) begin
         ws_valid <= 1'b0;
     end
     else if (ws_allowin) begin
@@ -160,6 +165,7 @@ end
 
 assign ws_csr_wvalue = ws_rkd_value;
 assign ws_reflush = ws_ertn_flush | ws_ex | ws_refetch_flg & ws_valid;
+assign ws_refetch_flush = ws_refetch_flg && ws_valid; // add
 
 assign rf_we = ws_gr_we && ws_valid && ~ws_ex;
 assign rf_waddr = ws_dest;
diff --git a/mycpu_core.v b/mycpu_core.v
index b8fe1b9..a3aa2f2 100644
--- a/mycpu_core.v
+++ b/mycpu_core.v
@@ -29,7 +29,10 @@ module mycpu_core (
     output wire [31:0]                  debug_wb_pc,
     output wire [ 3:0]                  debug_wb_rf_we,
     output wire [ 4:0]                  debug_wb_rf_wnum,
-    output wire [31:0]                  debug_wb_rf_wdata
+    output wire [31:0]                  debug_wb_rf_wdata,
+
+    //Icache
+    output wire [31:0]                  inst_addr_vrtl
 );
 
 reg         reset;
@@ -174,6 +177,13 @@ wire[1 :0] es_plv;
 wire       es_dmwhit;
 wire[1 :0] es_mmu_en;
 
+wire ws_refetch_flush;
+wire [31:0] ex_entry_refetchtarget;
+wire [31:0] ws_pc;
+assign ex_entry_refetchtarget = (ws_refetch_flush && ~ertn_flush) ? ws_pc + 3'h4 : csr_ertn_entry; // add
+
+
+
 IFstage my_if (
     .clk                    (clk),
     .resetn                 (resetn),
@@ -194,9 +204,9 @@ IFstage my_if (
     .fs2ds_valid            (fs2ds_valid),
 
     .csr_ex_entry           (csr_ex_entry  ),
-    .csr_ertn_entry         (csr_ertn_entry),
-    .ertn_flush             (ertn_flush),
-    .wb_ex                  (wb_ex     ),
+    .csr_ertn_entry         (ex_entry_refetchtarget),
+    .ertn_flush             (ertn_flush| ws_refetch_flush),
+    .wb_ex                  (wb_ex ), // add
     .fs_reflush             (ws_reflush),
 
     .s0_va_highbits         ({s0_vppn, s0_va_bit12}),/*TODO:Note that these two lines should have been placed in the MMU module as well, 
@@ -211,7 +221,10 @@ IFstage my_if (
     .plv                    (fs_plv),
     .dmw_hit                (fs_dmwhit),
     .mmu_asid               (fs_asid),
-    .fs_exc_ecode           (fs_exc_ecode)
+    .fs_exc_ecode           (fs_exc_ecode),
+
+    //Icache
+    .inst_addr_vrtl(inst_addr_vrtl)
 );
 
 MMU IF_mmu(
@@ -394,7 +407,10 @@ WBstage my_wb (
     .ws_ex                  (wb_ex),
     .ws2csr_bus             (ws2csr_bus),
     
-    .ws_csr_tlbrd           (ws_csr_tlbrd)
+    .ws_csr_tlbrd           (ws_csr_tlbrd),
+    
+    .ws_refetch_flush(ws_refetch_flush),
+    .ws_pc (ws_pc)
 
 );
 
diff --git a/mycpu_top.v b/mycpu_top.v
index 43560a7..42e4f9c 100644
--- a/mycpu_top.v
+++ b/mycpu_top.v
@@ -78,6 +78,29 @@ wire [31:0] data_sram_rdata  ;
 wire        data_sram_addr_ok;
 wire        data_sram_data_ok;
 
+//icache read channel
+wire [31:0] inst_addr_vrtl;
+wire        icache_addr_ok;
+wire        icache_data_ok;
+wire [31:0] icache_rdata;
+
+wire        icache_rd_req;
+wire [ 2:0] icache_rd_type;
+wire [31:0] icache_rd_addr;
+wire        icache_rd_rdy;
+wire        icache_ret_valid;
+wire        icache_ret_last;
+wire [31:0] icache_ret_data;
+
+//icache write channel
+wire        icache_wr_req;
+wire [ 2:0] icache_wr_type;
+wire [31:0] icache_wr_addr;
+wire [ 3:0] icache_wr_strb;
+wire [127:0]icache_wr_data;
+wire        icache_wr_rdy=1'b1;     
+
+
 mycpu_core u_mycpu_core(
     .clk               (aclk             ),
     .resetn            (aresetn          ),
@@ -88,9 +111,9 @@ mycpu_core u_mycpu_core(
     .inst_sram_wstrb   (inst_sram_wstrb  ),
     .inst_sram_addr    (inst_sram_addr   ),
     .inst_sram_wdata   (inst_sram_wdata  ),
-    .inst_sram_rdata   (inst_sram_rdata  ),
-    .inst_sram_addr_ok (inst_sram_addr_ok),
-    .inst_sram_data_ok (inst_sram_data_ok),
+    .inst_sram_rdata   (icache_rdata     ),
+    .inst_sram_addr_ok (icache_addr_ok   ),
+    .inst_sram_data_ok (icache_data_ok   ),
     
     .data_sram_req     (data_sram_req    ),
     .data_sram_wr      (data_sram_wr     ),
@@ -103,9 +126,44 @@ mycpu_core u_mycpu_core(
     .data_sram_data_ok (data_sram_data_ok),
      
     .debug_wb_pc       (debug_wb_pc      ),
-    .debug_wb_rf_we    (debug_wb_rf_we  ),
+    .debug_wb_rf_we    (debug_wb_rf_we   ),
     .debug_wb_rf_wnum  (debug_wb_rf_wnum ),
-    .debug_wb_rf_wdata (debug_wb_rf_wdata)
+    .debug_wb_rf_wdata (debug_wb_rf_wdata),
+
+    .inst_addr_vrtl    (inst_addr_vrtl   )
+);
+
+cache Icache(
+    //----------cpu interface------
+    .clk        (aclk                       ),
+    .resetn     (aresetn                    ),
+    .valid      (inst_sram_req              ),//pre-if request valid
+    .op         (inst_sram_wr               ),//1:WRITE 0:READ
+    .index      (inst_addr_vrtl[11:4]       ),//addr[11:4]
+    .tag        (inst_sram_addr[31:12]      ),//from tlb(mmu):inst_sram_addr[31:12]
+    .offset     (inst_addr_vrtl[3:0]        ),//addr[3:0]
+    .wstrb      (inst_sram_wstrb            ),//enable
+    .wdata      (inst_sram_wdata            ),
+    .addr_ok    (icache_addr_ok             ),//output
+    .data_ok    (icache_data_ok             ),
+    .rdata      (icache_rdata               ),//output
+    //--------AXI read interface-------
+    .rd_req     (icache_rd_req              ),//output
+    .rd_type    (icache_rd_type             ),
+    .rd_addr    (icache_rd_addr             ),
+
+    .rd_rdy     (icache_rd_rdy              ),//input æ€»çº¿å‘æ¥çš?
+    .ret_valid  (icache_ret_valid           ),
+    .ret_last   (icache_ret_last            ),
+    .ret_data   (icache_ret_data            ),
+
+    //--------AXI write interface------
+    .wr_req     (icache_wr_req              ),//output,å¯¹äºŽicacheæ°¸è¿œæ˜?0
+    .wr_type    (icache_wr_type             ),
+    .wr_addr    (icache_wr_addr             ),
+    .wr_wstrb   (icache_wr_strb             ),
+    .wr_data    (icache_wr_data             ),
+    .wr_rdy     (icache_wr_rdy              )//icacheä¸ä¼šçœŸæ­£è¦å†™sramï¼Œç½®1æ²¡æœ‰å…³ç³»
 );
 
 transfer_bridge u_transfer_bridge(
@@ -153,16 +211,6 @@ transfer_bridge u_transfer_bridge(
     .bvalid            (bvalid           ),
     .bready            (bready           ),
 
-    .inst_sram_en      (inst_sram_req    ),
-    .inst_sram_wr      (inst_sram_wr     ),
-    .inst_sram_size    (inst_sram_size   ),
-    .inst_sram_wstrb   (inst_sram_wstrb  ),
-    .inst_sram_addr    (inst_sram_addr   ),
-    .inst_sram_wdata   (inst_sram_wdata  ),
-    .inst_sram_rdata   (inst_sram_rdata  ),
-    .inst_sram_addr_ok (inst_sram_addr_ok),
-    .inst_sram_data_ok (inst_sram_data_ok),
-
     .data_sram_en      (data_sram_req    ),
     .data_sram_wr      (data_sram_wr     ),
     .data_sram_wstrb   (data_sram_wstrb  ),
@@ -171,7 +219,15 @@ transfer_bridge u_transfer_bridge(
     .data_sram_wdata   (data_sram_wdata  ),
     .data_sram_rdata   (data_sram_rdata  ),
     .data_sram_addr_ok (data_sram_addr_ok),
-    .data_sram_data_ok (data_sram_data_ok)
+    .data_sram_data_ok (data_sram_data_ok),
+
+    .icache_rd_req      (icache_rd_req      ),
+    .icache_rd_type     (icache_rd_type     ),
+    .icache_rd_addr     (icache_rd_addr     ),
+    .icache_rd_rdy      (icache_rd_rdy      ),
+    .icache_ret_valid   (icache_ret_valid   ),
+    .icache_ret_last    (icache_ret_last    ),
+    .icache_ret_data    (icache_ret_data    )
 );
 
 endmodule
\ No newline at end of file
diff --git a/transfer_bridge.v b/transfer_bridge.v
index f8c13e0..ab45153 100644
--- a/transfer_bridge.v
+++ b/transfer_bridge.v
@@ -49,16 +49,14 @@ module transfer_bridge(
     input  wire                     bvalid, // slave  -> master
     output wire                     bready, // master -> slave
 
-    // inst sram interface    
-    input  wire                     inst_sram_en     ,
-    input  wire                     inst_sram_wr     ,
-    input  wire   [ 1:0]            inst_sram_size   ,
-    input  wire   [ 3:0]            inst_sram_wstrb  ,
-    input  wire   [31:0]            inst_sram_addr   ,
-    input  wire   [31:0]            inst_sram_wdata  ,
-    output wire   [31:0]            inst_sram_rdata  ,
-    output wire                     inst_sram_addr_ok,
-    output wire                     inst_sram_data_ok,
+    // icache interface
+    input  wire         	         icache_rd_req,
+    input  wire[ 2:0]               icache_rd_type,
+    input  wire[31:0]               icache_rd_addr,
+    output wire         	         icache_rd_rdy,			// icache_addr_ok
+    output wire         	         icache_ret_valid,	// icache_data_ok
+	output wire			             icache_ret_last,
+    output wire[31:0]               icache_ret_data,
     
     // data sram interface
     input  wire                     data_sram_en     ,
@@ -70,6 +68,8 @@ module transfer_bridge(
     output wire   [31:0]            data_sram_rdata  ,
     output wire                     data_sram_addr_ok,
     output wire                     data_sram_data_ok
+
+
 );
 
     wire reset;
@@ -80,18 +80,28 @@ module transfer_bridge(
     reg [31:0] araddr_reg;
     reg  [2:0] arsize_reg;
     reg        arvalid_reg;
+    reg [7:0]  arlen_reg;
+    reg [1:0]  arburst_reg;
+    reg [1:0]  arlock_reg;
+    reg [3:0]  arcache_reg;
+    reg [2:0]  arprot_reg;
     assign arid = arid_reg;
     assign araddr = araddr_reg;
     assign arsize = arsize_reg;
     assign arvalid = arvalid_reg;
-    assign arlen    = 8'b0;
-    assign arburst  = 2'b1;
-    assign arlock   = 2'b0;
-    assign arcache  = 4'b0;
-    assign arprot   = 3'b0;
+    assign arlen = arlen_reg;
+    assign arburst = arburst_reg;
+    assign arlock   = arlock_reg;
+    assign arcache  =  arcache_reg;
+    assign arprot   =  arprot_reg;
+    // assign arlen    = 8'b0;
+    // assign arburst  = 2'b1;
+    // assign arlock   = 2'b0;
+    // assign arcache  = 4'b0;
+    // assign arprot   = 3'b0;
 
     // r
-    assign rready = r_business_cnt_inst != 1'b0 || r_business_cnt_data != 1'b0;
+    assign rready = rdata_curr_state[1] || rdata_curr_state[2];//r_business_cnt_inst != 1'b0 || r_business_cnt_data != 1'b0;
 
     // aw
     reg [31:0] awaddr_reg;
@@ -129,9 +139,10 @@ module transfer_bridge(
     parameter READ_DATA_REQ_CHECK   = 5'b01000; // 8
     parameter READ_REQ_END          = 5'b10000; // 16
 
-    parameter READ_DATA_RST         = 3'b001; // 1
-    parameter READ_DATA_START       = 3'b010; // 2
-    parameter READ_DATA_END         = 3'b100; // 8
+    parameter READ_DATA_RST         = 4'b0001; // 1
+    parameter READ_DATA_START       = 4'b0010; // 2
+    parameter READ_DATA_MID         = 4'b0100; // 4
+    parameter READ_DATA_END         = 4'b1000; // 8
 
     parameter WRITE_RST             = 3'b001; // 1
     parameter WRITE_START           = 3'b010; // 2
@@ -143,8 +154,8 @@ module transfer_bridge(
 
     reg  [ 4:0] rreq_curr_state;
     reg  [ 4:0] rreq_next_state;
-    reg  [ 2:0] rdata_curr_state;
-    reg  [ 2:0] rdata_next_state;
+    reg  [ 3:0] rdata_curr_state;
+    reg  [ 3:0] rdata_next_state;
     reg  [ 3:0] wrd_curr_state;
     reg  [ 3:0] wrd_next_state;
     reg  [ 2:0] wrsp_curr_state;
@@ -188,7 +199,7 @@ module transfer_bridge(
             READ_REQ_RST: begin
                 if(data_sram_en & ~data_sram_wr)
                     rreq_next_state = READ_DATA_REQ_CHECK;
-                else if(inst_sram_en)
+                else if(icache_rd_req)
                     rreq_next_state = READ_INST_REQ_START;
                 else
                     rreq_next_state = rreq_curr_state;
@@ -207,9 +218,14 @@ module transfer_bridge(
                 else
                     rreq_next_state = rreq_curr_state;
             end
-            
+
             READ_REQ_END: begin
-                rreq_next_state = READ_REQ_RST;
+                if(rdata_curr_state[3])begin
+                    rreq_next_state = READ_REQ_RST;
+                end
+                else begin
+                    rreq_next_state = READ_REQ_END;
+                end
             end
             default:
                 rreq_next_state = READ_REQ_RST;
@@ -230,17 +246,26 @@ module transfer_bridge(
             end
 
             READ_DATA_START: begin
-                if(rvalid && rready)
+                if(rvalid && rready && rlast)
                     rdata_next_state = READ_DATA_END;
-                else 
+                else if(rvalid && rready)
+                    rdata_next_state = READ_DATA_MID;
+                else
                     rdata_next_state = rdata_curr_state;
                 
             end
 
-            READ_DATA_END: begin
-                if(rvalid & rready)
+            READ_DATA_MID:begin
+                if(rvalid && rready && rlast)
+                    rdata_next_state = READ_DATA_END;
+                else if(rvalid && rready)
                     rdata_next_state = rdata_curr_state;
-                else if(r_business_cnt_inst != 1'b0 || r_business_cnt_data != 1'b0)
+                else
+                    rdata_next_state = READ_DATA_START;
+            end
+
+            READ_DATA_END: begin
+                if((arready && arvalid) || r_business_cnt_inst != 1'b0 || r_business_cnt_data != 1'b0)
                     rdata_next_state = READ_DATA_START;
                 else
                     rdata_next_state = READ_DATA_RST;
@@ -326,23 +351,27 @@ module transfer_bridge(
         if(reset) begin
             arid_reg <= 4'b0;
             araddr_reg <= 32'b0;
-            arsize_reg <= 3'b0;
+            arsize_reg <= 3'b010;
+            {arlen_reg,arburst_reg, arlock_reg, arcache_reg, arprot_reg} <= {8'b0,2'b01, 2'b0, 4'b0, 1'b0};
         end 
         else if(rreq_next_state == READ_DATA_REQ_START || rreq_curr_state == READ_DATA_REQ_START) begin
             arid_reg <= 4'b1;
             araddr_reg <= data_sram_addr;
             arsize_reg <= {1'b0, data_sram_size};
+            arlen_reg <= 8'b0;
         end 
         else if(rreq_next_state == READ_INST_REQ_START || rreq_curr_state == READ_INST_REQ_START) begin
             arid_reg <= 4'b0;
-            araddr_reg <= inst_sram_addr;
-            arsize_reg <= {1'b0, inst_sram_size};
+            araddr_reg <= icache_rd_addr;
+            //arsize_reg <= {2{icache_rd_type[2]}};//{1'b0, inst_sram_size};
+            arlen_reg <= 8'b00000011;
+            arburst_reg <= 2'b01;
         end 
-        else begin
+        /*else begin
             arid_reg <= 4'b0;
             araddr_reg <= 32'b0;
             arsize_reg <= 3'b0;
-        end
+        end*/
     end
 
     always @(posedge clk) begin
@@ -448,7 +477,7 @@ module transfer_bridge(
             r_business_cnt_inst <= 1'b0;
             r_business_cnt_data <= 1'b0;
         end
-        else if(arready & arvalid & rvalid & rready) begin
+        else if(arready & arvalid & rvalid & rready &rlast) begin
             if(~arid[0] && ~rid[0])
                 r_business_cnt_inst <= r_business_cnt_inst;
             if(arid[0] && rid[0])
@@ -468,7 +497,7 @@ module transfer_bridge(
             if(arid[0])
                 r_business_cnt_data <= r_business_cnt_data + 2'b1;
         end
-        else if (rvalid & rready) begin
+        else if (rvalid & rready & rlast) begin
             if(~rid[0])
                 r_business_cnt_inst <= r_business_cnt_inst - 2'b1;
             if(rid[0])
@@ -479,10 +508,13 @@ module transfer_bridge(
 
     
 
-    assign inst_sram_addr_ok = rreq_curr_state == READ_REQ_END && ~arid[0];
-    assign inst_sram_data_ok = rdata_curr_state == READ_DATA_END && ~rid_reg[0];
-    assign data_sram_addr_ok = (rreq_curr_state == READ_REQ_END && arid[0]) || (wrd_curr_state == WRITE_END); //read or write
-    assign data_sram_data_ok = (rdata_curr_state == READ_DATA_END && rid_reg[0]) || (wrsp_curr_state == WRITE_RSP_END); //read or write
+    //assign inst_sram_addr_ok = rreq_curr_state == READ_REQ_END && ~arid[0];
+    //assign inst_sram_data_ok = rdata_curr_state == READ_DATA_END && ~rid_reg[0];
+    assign icache_rd_rdy = rreq_curr_state == READ_REQ_END && ~arid[0];
+    assign icache_ret_valid = (|rdata_curr_state[3:2]) && ~rid_reg[0];
+    assign icache_ret_last = rdata_curr_state[3] && ~rid_reg[0];
+    assign data_sram_addr_ok = arid[0] & arvalid & arready | wid[0] & awvalid & awready ; //read or write
+    assign data_sram_data_ok = ((|rdata_curr_state[3:2]) && rid_reg[0]) || (wrsp_curr_state == WRITE_RSP_END); //read or write
 
     reg [31:0] inst_sram_buf;
     reg [31:0] data_sram_buf;
@@ -501,7 +533,7 @@ module transfer_bridge(
             data_sram_buf <= rdata;
     end
 
-    assign inst_sram_rdata = inst_sram_buf;
+    assign icache_ret_data = inst_sram_buf;
     assign data_sram_rdata = data_sram_buf;
 
 
