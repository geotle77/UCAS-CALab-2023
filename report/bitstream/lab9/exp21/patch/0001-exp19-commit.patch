From 5fc942df406600634bd1793ef5cdc0d4e5e43e08 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?=E8=91=A1=E8=90=84=E7=B3=96?= <madifeng21@mails.ucas.ac.cn>
Date: Thu, 28 Dec 2023 00:25:25 +0800
Subject: [PATCH] exp19 commit

---
 BUS_LEN.vh        |   6 +-
 CSR.vh            |  20 +-
 EXEstage.v        | 141 ++++++----
 IDstage.v         |  70 ++---
 IFstage.v         |  72 +++--
 MEMstage.v        |  46 +--
 MMU.v             | 100 +++++++
 WBstage.v         |  71 ++---
 alu.v             |  14 +-
 csr.v             | 251 ++++++++++++-----
 div.v             |  42 +--
 mul.v             |  48 ++--
 mycpu_core.v      | 698 +++++++++++++++++++++++++---------------------
 mycpu_top.v       | 110 ++++----
 preIFstage.v      |  88 ------
 regfile.v         |  22 +-
 tlb.v             | 128 ++++-----
 transfer_bridge.v | 138 ++++-----
 18 files changed, 1158 insertions(+), 907 deletions(-)
 create mode 100644 MMU.v
 delete mode 100644 preIFstage.v

diff --git a/BUS_LEN.vh b/BUS_LEN.vh
index 5884502..8b56636 100644
--- a/BUS_LEN.vh
+++ b/BUS_LEN.vh
@@ -1,10 +1,10 @@
 `ifndef BUS_LEN
 
     `define BR_BUS        34
-    `define FS2DS_BUS_LEN 97  //fs_exc_data, fs_pc, inst
+    `define FS2DS_BUS_LEN 103  //fs_exc_ecode,fs_exc_data, fs_pc, inst
     `define DS2ES_BUS_LEN 309 //es_pc, alu_src1, alu_src2, alu_op,load_op,store_op, rkd_value, gr_we, dest, mem_we,ds_exc_data, time_op
-    `define ES2MS_BUS_LEN 219  //ms_pc, mul_op,mem_gr_we, mem_dest, final_result,es_rl_value, es_exc_date
-    `define MS2WS_BUS_LEN 213
+    `define ES2MS_BUS_LEN 231  //ms_pc, mul_op,mem_gr_we, mem_dest, final_result,es_rl_value, es_exc_date
+    `define MS2WS_BUS_LEN 219  //wms_refetch_flg,ms_inst_tlbsrch,ms_inst_tlbrd,ms_inst_tlbwr,ms_inst_tlbfill,ms_tlbsrch_hit,ms_tlbsrch_hit_index, ms_pc, mem_gr_we, mem_dest,  mem_final_result, mem_rkd_value,mem_exc_data
     
     `define FORWARD_BUS_LEN 38
     `define WS_TO_FS_CSR_DATA_LEN 200
diff --git a/CSR.vh b/CSR.vh
index e90a150..d406635 100644
--- a/CSR.vh
+++ b/CSR.vh
@@ -1,5 +1,5 @@
 `ifndef CSR 
-    `define WS2CSR_BUS_LEN 200
+    `define WS2CSR_BUS_LEN 210
     
     `define EXCEPT_LEN 82
     `define ALU_OP_LEN 19
@@ -81,5 +81,23 @@
     `define CSR_ASID_ASID       9:0
     // TLBRENTRY
     `define CSR_TLBRENTRY_PA    31:6
+
+    //exp19
+    `define CSR_DMW0            14'h180
+    `define CSR_DMW1            14'h181
+
+    `define CSR_DMW_PLV0        0
+    `define CSR_DMW_PLV3        3
+    `define CSR_DMW_MAT         5:4
+    `define CSR_DMW_PSEG        27:25
+    `define CSR_DMW_VSEG        31:29
+
+    `define ECODE_PIL           6'h1
+    `define ECODE_PIS           6'h2
+    `define ECODE_PIF           6'h3
+    `define ECODE_PME           6'h4
+    `define ECODE_PPI           6'h7 
+    `define ECODE_TLBR          6'h3f
+    `define ESUBCODE_ADEM       9'h1
     
 `endif
\ No newline at end of file
diff --git a/EXEstage.v b/EXEstage.v
index 33b9daf..793834c 100644
--- a/EXEstage.v
+++ b/EXEstage.v
@@ -1,55 +1,67 @@
 `include "BUS_LEN.vh"
 `include "CSR.vh"
 module EXEstage (
-    input wire clk,
-    input wire resetn,
-    input wire reset,
+    input   wire                        clk,
+    input   wire                        resetn,
+    input   wire                        reset,
 
     //interface with SRAM
-    output wire                         data_sram_en,
-    output wire                         data_sram_wr,
-    output wire [ 3:0]                  data_sram_we,
-    output wire [ 1:0]                  data_sram_size,
-    output wire [31:0]                  data_sram_addr,
-    output wire [31:0]                  data_sram_wdata,
-    input wire                          data_sram_addr_ok,
+    output  wire                         data_sram_en,
+    output  wire                         data_sram_wr,
+    output  wire [ 3:0]                  data_sram_we,
+    output  wire [ 1:0]                  data_sram_size,
+    output  wire [31:0]                  data_sram_addr,
+    output  wire [31:0]                  data_sram_wdata,
+    input   wire                          data_sram_addr_ok,
     
     // interface between IDstage and EXEstage
-    output wire                         es_allowin,
-    input  wire                         ds2es_valid,
-    input  wire [`DS2ES_BUS_LEN-1:0]    ds2es_bus,
+    output  wire                         es_allowin,
+    input   wire                         ds2es_valid,
+    input   wire [`DS2ES_BUS_LEN-1:0]    ds2es_bus,
 
     // interface between EXEstage and MEMstage
-    input  wire                         ms_allowin,
-    output wire                         es2ms_valid,
-    output wire [`ES2MS_BUS_LEN-1:0]    es2ms_bus,
-    output wire [67:0]                  mul_result,
+    input   wire                         ms_allowin,
+    output  wire                         es2ms_valid,
+    output  wire [`ES2MS_BUS_LEN-1:0]    es2ms_bus,
+    output  wire [67:0]                  mul_result,
 
 
     // forward data
-    output wire [`FORWARD_BUS_LEN-1:0]  exe_forward_zip,
+    output  wire [`FORWARD_BUS_LEN-1:0]  exe_forward_zip,
     
 
-    input  wire mul_block,     // mul or load in ID
-    output reg  es_block,      // mul or load in EXE
-    output wire es_mem_block,  // load/store or CSRwrite/read in EXE
+    input   wire                         mul_block,     // mul or load in ID
+    output  reg                          es_block,      // mul or load in EXE
+    output  wire                         es_mem_block,  // load/store or CSRwrite/read in EXE
 
-    input  wire ms_ex_to_es,   // from MEM
-    input  wire es_reflush,    // syscall in WB
-    output wire es_csr_re,     // to ID
+    input   wire                         ms_ex_to_es,   // from MEM
+    input   wire                         es_reflush,    // syscall in WB
+    output  wire                         es_csr_re,     // to ID
 
 
     // exp 18
     // to tlb
-    output wire [19:0] s1_va_highbits,
-    output wire [ 9:0] s1_asid,
-    output wire        invtlb_valid,
-    output wire [ 4:0] invtlb_op,
+                
+    output  wire [19:0]                  s1_va_highbits,
+    output  wire [ 9:0]                  s1_asid,
+    output  wire                         invtlb_valid,
+    output  wire [ 4:0]                  invtlb_op,
+        //exp 18
+    input   wire                         s1_found,   // from tlb
+    input   wire [ 3:0]                  s1_index,   // from tlb
     // from csr, used for tlbsrch
-    input  wire [ 9:0] csr_asid_asid,
-    input  wire [18:0] csr_tlbehi_vppn,
+    input   wire [ 9:0]                  csr_asid_asid,
+    input   wire [18:0]                  csr_tlbehi_vppn,
     // blk tlbsrch
-    input  wire        ms_csr_tlbrd
+    input   wire                         ms_csr_tlbrd,
+    input   wire                         ws_csr_tlbrd,
+    // from mmu
+    input wire [5:0]                     es_exc_ecode,
+    output wire [31:0]                   va,
+    output wire [1:0]                    mmu_en,
+    input wire [31:0]                    pa,
+    input   wire [1:0]                   plv,
+    input   wire                         dmw_hit  
 );
 
 //--------------------declaration--------------------
@@ -63,11 +75,6 @@ always @(posedge clk) begin
   end
 end
 
-
-
-
-
-
 wire                          es_refetch_flg;
 wire [4:0]                    es_invtlb_op;
 wire                          es_inst_tlbsrch;
@@ -75,6 +82,9 @@ wire                          es_inst_tlbrd;
 wire                          es_inst_tlbwr;
 wire                          es_inst_tlbfill;
 wire                          es_inst_invtlb;
+// TLB
+wire        es_tlbsrch_hit;
+wire [ 3:0] es_tlbsrch_hit_index;
 
 wire [31:0]                   es_pc;
 wire                          es_res_from_mul;
@@ -119,11 +129,17 @@ assign {es_refetch_flg,
 wire                        es_mem_we;
 wire                        es_res_from_mem;
 wire [`ES_EXC_DATA_WD-1:0]  es_exc_data;
-assign es2ms_bus = {es_refetch_flg,
+
+wire [5:0]                  es_tlb_ecode;
+assign es2ms_bus = {es_adem,
+                    es_tlb_ecode,
+                    es_refetch_flg,
                     es_inst_tlbsrch,
                     es_inst_tlbrd,
                     es_inst_tlbwr,
                     es_inst_tlbfill,
+                    es_tlbsrch_hit,
+                    es_tlbsrch_hit_index,
                     es_mem_we,
                     es_res_from_mem,
                     es_pc,
@@ -176,7 +192,9 @@ wire        ld_ale         ;
 wire        st_ale         ;
 wire        es_ale         ;
 wire [ 5:0] ds_ecode       ;
+wire [ 8:0] ds_esubcode    ;
 wire [ 5:0] es_ecode       ;
+wire es_adem;
 
 
 
@@ -201,11 +219,19 @@ assign es_final_result  = {32{es_time_op[0]}}                 & counter[31: 0]
                         | {32{es_time_op[1]}}                 & counter[63:32]
                         | {32{~es_time_op[0]&~es_time_op[1]}} & es_alu_result;
 
-
-
-assign es_wrong_addr  = es_adef ? ds_wrong_addr : es_alu_result;
-assign es_ecode       = es_ale  ? `ECODE_ALE    : ds_ecode;
-assign es_ex          = (ds_ex | es_ale) & es_valid;
+assign es_adem = es_need_mem & es_alu_result[31] & (plv == 2'd3) & ~(dmw_hit);
+assign es_wrong_addr  = ds_ex ? ds_wrong_addr : es_alu_result;
+assign es_ecode       =   ds_ex    ? ds_ecode
+                        : es_adem  ? `ECODE_ADE
+                        : es_ale   ? `ECODE_ALE
+                        : es_tlb_ecode[0] ? `ECODE_TLBR
+                        : es_tlb_ecode[5] ? `ECODE_PIL
+                        : es_tlb_ecode[4] ? `ECODE_PIS
+                        : es_tlb_ecode[1] ? `ECODE_PPI
+                        : es_tlb_ecode[2] ? `ECODE_PME
+                        : 6'h0;
+assign es_esubcode    =  es_adem ? `ESUBCODE_ADEM : ds_esubcode;
+assign es_ex          = (ds_ex | es_ale |es_adem | (|es_tlb_ecode)) & es_valid;
 
 assign {es_csr_op,
         es_adef,         // 97
@@ -216,7 +242,7 @@ assign {es_csr_op,
         es_csr_num,      // 30:17
         es_ertn_flush,   // 16
         ds_ex,           // 15
-        es_esubcode,     // 14:6
+        ds_esubcode,     // 14:6
         ds_ecode         // 5:0
         } = ds_exc_data;
 
@@ -240,10 +266,10 @@ assign es_exc_data = {es_csr_op,
 //--------------------pipeline control--------------------
 
 wire tlbsrch_blk;
-assign tlbsrch_blk = es_inst_tlbsrch & ms_csr_tlbrd;
+assign tlbsrch_blk = es_inst_tlbsrch & (ms_csr_tlbrd|ws_csr_tlbrd);
 
 wire es_ready_go;
-assign es_ready_go = es_need_mem ? (es_reflush || es_finish || data_sram_en && data_sram_addr_ok && !tlbsrch_blk)
+assign es_ready_go = es_need_mem ? (es_reflush || es_finish || data_sram_en && data_sram_addr_ok && !tlbsrch_blk|| (|es_tlb_ecode) || es_adem)
                                     : (es_reflush || alu_flag && es_valid && !tlbsrch_blk); 
 assign es_allowin = ~es_valid || es_ready_go && ms_allowin;
 assign es2ms_valid = es_valid && es_ready_go;
@@ -325,13 +351,13 @@ assign mem_we=(|es_store_op);
 assign es_mem_we = mem_we & ~es_reflush & ~ms_ex_to_es & ~st_ale;
 assign es_rf_we = es_valid && es_gr_we;
 
-assign data_sram_en    =  ~es_finish && es_need_mem && ms_allowin;//1'b1;
+assign data_sram_en    =  ~es_finish && es_need_mem && ms_allowin &&~(|es_tlb_ecode) && ~es_adem;//1'b1;
 assign data_sram_size  = (es_store_op[0] | es_load_op[0] | es_load_op[3]) ? 2'b00   // load b, bu or store b
                        : (es_store_op[1] | es_load_op[1] | es_load_op[4]) ? 2'b01   // load h, hu or store h
                        : 2'b10;
 assign data_sram_wr    =  |es_store_op;
 assign data_sram_we    =  es_mem_we ? st_strb : 4'b0000;
-assign data_sram_addr  =  es_alu_result;
+//assign data_sram_addr  =  es_alu_result;
 assign data_sram_wdata =  st_data;
 
 
@@ -350,13 +376,26 @@ booth_multiplier u_mul(
   .z(mul_result)
 );
 
+assign es_tlbsrch_hit = s1_found & es_inst_tlbsrch;
+assign es_tlbsrch_hit_index = s1_index & {4{es_inst_tlbsrch}};
 
 
-
-// TLB
-assign s1_va_highbits = invtlb_valid ? es_rkd_value[31:12] : {csr_tlbehi_vppn, 1'b0};
-assign s1_asid        = invtlb_valid ? es_rj_value [ 9: 0] : csr_asid_asid;
+assign s1_va_highbits = es_need_mem ? es_alu_result[31:12] : invtlb_valid ? es_rkd_value[31:12] : {csr_tlbehi_vppn, 1'b0};
+assign s1_asid = (es_need_mem | ~es_need_mem & ~invtlb_valid) ? csr_asid_asid : es_rj_value[9:0]; 
 assign invtlb_valid   = es_inst_invtlb;
 assign invtlb_op      = es_invtlb_op;
 
+//exp 19
+assign mmu_en ={{1'b0},{es_need_mem}};
+
+wire    ecode_pil;
+wire    ecode_pis;
+wire    ecode_pme;
+assign  ecode_pil       = es_exc_ecode[5] & es_res_from_mem;
+assign  ecode_pis       = es_exc_ecode[4] & es_mem_we;
+assign  ecode_pme       = es_exc_ecode[2] & es_mem_we;
+assign  es_tlb_ecode    = {ecode_pil,ecode_pis,es_exc_ecode[3],ecode_pme,es_exc_ecode[1],es_exc_ecode[0]} & {6{es_need_mem}}; //only check tlb error when it is ld or store
+assign  va              = es_alu_result;
+assign  data_sram_addr  = pa;
+
 endmodule
\ No newline at end of file
diff --git a/IDstage.v b/IDstage.v
index 19c5163..90a43c9 100644
--- a/IDstage.v
+++ b/IDstage.v
@@ -22,42 +22,43 @@ module IDstage (
     input  wire [`FORWARD_BUS_LEN-1:0]    exe_forward_zip,
     input  wire [`FORWARD_BUS_LEN-1:0]    mem_forward_zip,
 
-    output wire mul_block,      // mul or load in ID
-    input  wire es_block,       // mul or load in EXE
-    input  wire es_mem_block,   // load/store or CSRwrite/read in EXE
-    input  wire ms_mem_block,   // load/store or CSRwrite/read in MEM
+    output wire                           mul_block,      // mul or load in ID
+    input  wire                           es_block,       // mul or load in EXE
+    input  wire                           es_mem_block,   // load/store or CSRwrite/read in EXE
+    input  wire                           ms_mem_block,   // load/store or CSRwrite/read in MEM
 
-    input  wire es_csr_re,      // CSRread in EXE
-    input  wire ms_csr_re,      // CSRread in EXE
+    input  wire                           es_csr_re,      // CSRread in EXE
+    input  wire                           ms_csr_re,      // CSRread in EXE
 
-    input  wire ds_reflush,     // syscall in WB
-    input  wire ds_has_int      // interrupt from CSR
+    input  wire                           ds_reflush,     // syscall in WB
+    input  wire                           ds_has_int      // interrupt from CSR
 );
 
 
 
 
 // forward data from exe,mem,wb
-wire        rf_we;
-wire [4:0]  rf_waddr;
-wire [31:0] rf_wdata;
+wire                                 rf_we;
+wire [4 :0]                          rf_waddr;
+wire [31:0]                          rf_wdata;
 assign {rf_we, rf_waddr, rf_wdata} = rf_zip;
 
-wire        exe_rf_we;
-wire        mem_rf_we;
-wire [4:0]  exe_dest;
-wire [4:0]  mem_dest;
-wire [31:0] alu_result;
-wire [31:0] final_result;
-assign {exe_rf_we, exe_dest, alu_result}   = exe_forward_zip;//waiting to add the es_mem_block
-assign {mem_rf_we, mem_dest, final_result} = mem_forward_zip;//waiting to add the ms_mem_block
+wire                                          exe_rf_we;
+wire                                          mem_rf_we;
+wire [4 :0]                                   exe_dest;
+wire [4 :0]                                   mem_dest;
+wire [31:0]                                   alu_result;
+wire [31:0]                                   final_result;
+assign {exe_rf_we, exe_dest, alu_result}   =  exe_forward_zip;//waiting to add the es_mem_block
+assign {mem_rf_we, mem_dest, final_result} =  mem_forward_zip;//waiting to add the ms_mem_block
 
 // exception data from fs
-wire [`FS_EXC_DATA_WD-1:0]  fs_exc_data;
-wire [31:0]                 ds_inst;
-wire [31:0]                 ds_pc;
-wire [31:0]                 ds_wrong_addr;
-wire                        ds_adef;
+wire [`FS_EXC_DATA_WD-1:0]        fs_exc_data;
+wire [5 :0]                       ds_exc_ecode;
+wire [31:0]                       ds_inst;
+wire [31:0]                       ds_pc;
+wire [31:0]                       ds_wrong_addr;
+wire                              ds_adef;
 assign {ds_adef, ds_wrong_addr} = fs_exc_data;
 
 // fs to ds bus
@@ -73,7 +74,7 @@ always @(posedge clk) begin
       fs2ds_bus_reg <= fs2ds_bus;
     end
   end
-assign {fs_exc_data,ds_pc,ds_inst} = fs2ds_bus_reg;
+assign {ds_exc_ecode,fs_exc_data,ds_pc,ds_inst} = fs2ds_bus_reg;
 
 
 // br
@@ -104,7 +105,6 @@ assign ds2es_bus = {ds_refetch_flg, //272
                     inst_tlbwr,     //264
                     inst_tlbfill,   //263
                     inst_invtlb,    //262
-
                     ds_pc,          //230:261
                     res_from_mul,   //229:229
                     alu_src1,       //197:228
@@ -541,7 +541,7 @@ assign mul_block = (|load_op) || res_from_mul;
 
 
 //------------------exception------------------
-assign ds_ine = ~ ( inst_add_w     | inst_sub_w   | inst_slt     | inst_sltu      |
+assign ds_ine = ~ ( inst_add_w  | inst_sub_w   | inst_slt     | inst_sltu      |
                  inst_nor       | inst_and     | inst_or      | inst_xor       |   
                  inst_slli_w    | inst_srli_w  | inst_srai_w  | inst_addi_w    | 
                  inst_ld_w      | inst_st_w    | inst_jirl    | inst_b         |
@@ -555,22 +555,25 @@ assign ds_ine = ~ ( inst_add_w     | inst_sub_w   | inst_slt     | inst_sltu
                  inst_st_b      | inst_st_h    | inst_csrrd   | inst_csrwr     |
                  inst_csrxchg   | inst_ertn    | inst_syscall | inst_break     |
                  inst_rdcntvl   | inst_rdcntvh | inst_rdcntid | inst_invtlb    |
-                 inst_tlbrd     | inst_tlbwr   | inst_tlbfill | inst_tlbsrch )
-            | inst_invtlb & (invtlb_op > 5'd6) ;
+                 inst_tlbrd     | inst_tlbwr   | inst_tlbfill | inst_tlbsrch ) | 
+                 inst_invtlb & (invtlb_op > 5'd6) ;
 assign ds_csr_re    = inst_csrrd | inst_csrwr | inst_csrxchg |inst_rdcntid;
 assign ds_csr_we    = inst_csrwr | inst_csrxchg;
-assign ds_csr_wmask    = {32{inst_csrxchg}} & rj_value | {32{inst_csrwr}};
+assign ds_csr_wmask = {32{inst_csrxchg}} & rj_value | {32{inst_csrwr}};
 assign csr_wvalue   = rkd_value;
 assign ds_csr_num   = {14{inst_rdcntid}} & `CSR_TID | {14{~inst_rdcntid}} & ds_inst[23:10];
 
 assign ds_ertn_flush = ds_valid & inst_ertn;
-assign ds_ex = ds_valid & (inst_syscall | inst_break | ds_ine | ds_has_int | ds_adef);
+assign ds_ex = ds_valid & (inst_syscall | inst_break | ds_ine | ds_has_int | ds_adef |(|ds_exc_ecode));
 
 assign ds_ecode = ds_has_int   ? `ECODE_INT
                 : ds_adef      ? `ECODE_ADE
                 : ds_ine       ? `ECODE_INE
                 : inst_break   ? `ECODE_BRK
-                : inst_syscall ? `ECODE_SYS : 6'b0;
+                : inst_syscall ? `ECODE_SYS
+                : ds_exc_ecode[0] ? `ECODE_TLBR   // priority: TLBR > else
+                : ds_exc_ecode[3] ? `ECODE_PIF
+                : ds_exc_ecode[1] ? `ECODE_PPI: 6'b0;
 assign ds_esubcode = ds_adef ? `ESUBCODE_ADEF : 9'b0;
 assign ds_exc_data = {ds_csr_op,
                      ds_adef,      //97:97
@@ -589,8 +592,9 @@ assign ds_exc_data = {ds_csr_op,
 wire [3:0]  ds_csr_op;
 assign ds_csr_op = {inst_rdcntid, inst_csrxchg, inst_csrwr, inst_csrrd};
 //TODO:why we need refetch in these cases?
+/*These instructions block whenever they occur, regardless of whether or not they are write-after-read related.*/
 assign ds_refetch_flg = inst_tlbfill || inst_tlbwr || inst_tlbrd || inst_invtlb ||
-                        (ds_csr_op[2] || ds_csr_op[1]) && (ds_csr_num == `CSR_CRMD || ds_csr_num == `CSR_ASID);
+                        (ds_csr_we) && (ds_csr_num == `CSR_CRMD || ds_csr_num == `CSR_ASID);
 assign invtlb_op = rd;
 
 endmodule
\ No newline at end of file
diff --git a/IFstage.v b/IFstage.v
index 2bc9440..78cacf0 100644
--- a/IFstage.v
+++ b/IFstage.v
@@ -1,4 +1,5 @@
 `include "BUS_LEN.vh"
+`include "CSR.vh"
 module IFstage (
     input  wire                       clk,
     input  wire                       resetn,
@@ -27,14 +28,24 @@ module IFstage (
 
     // interface with CSR
     input wire [31: 0]                csr_ex_entry,
-    input wire [31: 0]                csr_ertn_entry
+    input wire [31: 0]                csr_ertn_entry,
+    //exp19
+    output wire [31:0]                va,
+    input  wire [31:0]                pa,
+    input wire  [ 5:0]                fs_exc_ecode,
+    input wire                        dmw_hit,
+    input wire  [1:0]                 plv,
+    input wire  [9:0]                 mmu_asid,
+    // to tlb
+    output wire [19:0]                s0_va_highbits,
+    output wire [ 9:0]                s0_asid
 );
 
 
 wire [31:0] seq_pc;
 wire [31:0] nextpc;
 
-wire br_stall;//
+wire br_stall;
 wire br_taken;
 wire [31:0] br_target;
 
@@ -49,6 +60,21 @@ reg  pfs_valid;
 wire pfs_ready_go;
 wire to_fs_valid;
 
+
+//exp13
+wire        fs_adef;
+wire [31:0] fs_wrong_addr;
+wire [`FS_EXC_DATA_WD-1:0] fs_exc_data;
+
+reg fs_ertn_valid;//delay ertn_flush
+reg fs_ex_valid;//delay wb_ex
+reg [31: 0]fs_ertn_entry;
+reg [31: 0]fs_ex_entry;
+reg fs_br_taken;
+reg [31: 0] fs_br_target;
+reg fs_br_stall;
+
+wire [5:0] fs_exc_ecode;
 assign {br_stall, br_taken, br_target} = br_zip;
 
 //------------------pre-IF stage------------------
@@ -73,7 +99,7 @@ assign inst_sram_we       = 4'b0;
 assign inst_sram_size     = 2'b10;
 assign inst_sram_wstrb    = 4'b0;
 assign inst_sram_wdata    = 32'b0;
-assign inst_sram_addr     = nextpc;
+//assign inst_sram_addr     = nextpc;
 
 ////////// IF to ID inst buf////////
 reg [31: 0] fs_inst_buf;
@@ -113,30 +139,25 @@ end
 
 assign fs_ready_go = fs_valid && inst_sram_data_ok || fs_inst_valid && ~fs_inst_cancel;//consider two cases: 1. the inst is from the sram 2. the inst is from the inst_buf
 assign fs_inst     = fs_inst_valid ? fs_inst_buf : inst_sram_rdata;//don't need to wait the data_ok signal
-assign fs2ds_bus = {fs_exc_data,    //95:64
+assign fs2ds_bus = {fs_exc_ecode,   //102:97
+                    fs_exc_data,    //96:64
                     fs_pc,          //63:32
-                    fs_inst};          //31:0
+                    fs_inst};       //31:0
 assign fs2ds_valid = fs_valid && fs_ready_go && ~fs_inst_cancel ;
 
 //////////excption information////////
-//exp13
-wire        fs_adef;
-wire [31:0] fs_wrong_addr;
-wire [`FS_EXC_DATA_WD-1:0] fs_exc_data;
 
-assign fs_adef = fs_pc[1] | fs_pc[0];
+//TODO:why we should check the fs_pc[31]?
+/*this is because the fs[31] can be used to distinguish between user space and kernel space, 
+and only high privileges can access kernel space  
+*/
+assign fs_adef = fs_pc[1] | fs_pc[0] |(plv == 2'd3 & fs_pc[31] & ~(dmw_hit)); 
 assign fs_wrong_addr = fs_pc;
 assign fs_exc_data    = {fs_valid & fs_adef, // 32:32
                          fs_wrong_addr       // 31:0
                         };
 
-reg fs_ertn_valid;//delay ertn_flush
-reg fs_ex_valid;//delay wb_ex
-reg [31: 0]fs_ertn_entry;
-reg [31: 0]fs_ex_entry;
-reg fs_br_taken;
-reg [31: 0] fs_br_target;
-reg fs_br_stall;
+
 
 assign seq_pc = fs_pc + 3'h4;
 assign nextpc  =  wb_ex? csr_ex_entry:   //the nextpc is updated in these cases
@@ -196,18 +217,13 @@ always @(posedge clk) begin
 end
 
 
-
-
-
-
-
 //----------add----------
 reg pfs_reflush;
 
 always @(posedge clk) begin
     if(~resetn)
         pfs_reflush <= 1'b0;
-    else if(inst_sram_en && (fs_reflush | br_taken &~ br_stall | (br_stall | fs_br_stall)&inst_sram_addr_ok))
+    else if(inst_sram_en && (fs_reflush | ((br_taken &~ br_stall) | (br_stall | fs_br_stall))&inst_sram_addr_ok))
         pfs_reflush <= 1'b1;
     else if(inst_sram_data_ok)
         pfs_reflush <= 1'b0;
@@ -227,8 +243,14 @@ always @(posedge clk) begin
 end
 
 
-wire fs_inst_cancel;
-assign fs_inst_cancel = fs_reflush | fs_reflush_reg | br_taken & ~br_stall | fs_br_taken;
+wire    fs_inst_cancel;
+assign  fs_inst_cancel = fs_reflush | fs_reflush_reg | br_taken & ~br_stall | fs_br_taken;
 
+assign va = nextpc;
+assign inst_sram_addr = pa;
 
+//exp 19 
+assign s0_va_highbits = nextpc[31:12];
+assign s0_asid = mmu_asid;
 endmodule
+
diff --git a/MEMstage.v b/MEMstage.v
index 21a5a02..25ec901 100644
--- a/MEMstage.v
+++ b/MEMstage.v
@@ -23,15 +23,12 @@ module MEMstage (
     output wire [`FORWARD_BUS_LEN-1:0]  mem_forward_zip,
     
 
-    output wire ms_mem_block, // load/store or CSRwrite/read in MEM
+    output wire                         ms_mem_block, // load/store or CSRwrite/read in MEM
 
-    output wire ms_ex_to_es,  // to EXE
-    input  wire ms_reflush,   // syscall in WB
-    output wire ms_csr_re,    // to ID
+    output wire                         ms_ex_to_es,  // to EXE
+    input  wire                         ms_reflush,   // syscall in WB
+    output wire                         ms_csr_re,    // to ID
 
-    //exp 18
-    input wire                          s1_found,   // from tlb
-    input wire                   [ 3:0] s1_index,   // from tlb
     output wire                         ms_csr_tlbrd  // to EXE
 );
 
@@ -45,6 +42,12 @@ wire          ms_inst_tlbsrch;
 wire          ms_inst_tlbrd;
 wire          ms_inst_tlbwr;
 wire          ms_inst_tlbfill;
+// TLB search result
+wire          ms_tlbsrch_hit;
+wire [ 3:0]   ms_tlbsrch_hit_index;
+wire [ 5:0]   ms_exc_ecode; 
+wire          ms_adem;
+
 wire          mem_we;
 wire          ms_res_from_mem;
 wire [31:0]   ms_pc;
@@ -57,11 +60,15 @@ wire          mem_gr_we;
 wire [31:0]   mem_rkd_value;
 wire [`MS_EXC_DATA_WD-1 : 0] mem_exc_data;
 reg[`ES2MS_BUS_LEN-1:0] es2ms_bus_reg;
-assign {ms_refetch_flg,
+assign {ms_adem,
+        ms_exc_ecode,
+        ms_refetch_flg,
         ms_inst_tlbsrch,
         ms_inst_tlbrd,
         ms_inst_tlbwr,
         ms_inst_tlbfill,
+        ms_tlbsrch_hit,
+        ms_tlbsrch_hit_index,
         mem_we,
         ms_res_from_mem,
         ms_pc,
@@ -82,7 +89,9 @@ assign mem_forward_zip = {mem_rf_we,
                           mem_final_result
                           };
 
-assign ms2ws_bus = {ms_refetch_flg,
+assign ms2ws_bus = {
+                    ms_exc_ecode,
+                    ms_refetch_flg,
                     ms_inst_tlbsrch,
                     ms_inst_tlbrd,
                     ms_inst_tlbwr,
@@ -113,7 +122,7 @@ assign ms_need_mem = ms_valid && (ms_res_from_mem || mem_we);
 
 
 wire ms_ready_go;
-assign ms_ready_go = ms_need_mem && data_sram_data_ok ||  ~ms_need_mem;
+assign ms_ready_go = ms_need_mem && (data_sram_data_ok ||(|ms_exc_ecode) || ms_adem) ||  ~ms_need_mem;
 assign ms_allowin = ~ms_valid || ms_ready_go && ws_allowin;
 assign ms2ws_valid = ms_valid && ms_ready_go;
 
@@ -140,18 +149,13 @@ end
 
 
 
-// TLB search result
-wire        ms_tlbsrch_hit;
-wire [ 3:0] ms_tlbsrch_hit_index;
-
-assign ms_tlbsrch_hit = s1_found;
-assign ms_tlbsrch_hit_index = s1_index;
-
-assign ms_csr_tlbrd = ( ( mem_csr_num == `CSR_ASID || mem_csr_num == `CSR_TLBEHI) && (mem_csr_op[2]||mem_csr_op[1])
-                     || ms_inst_tlbrd) && ms_valid;
 
 
+//assign ms_tlbsrch_hit = s1_found;
+//assign ms_tlbsrch_hit_index = s1_index;
 
+assign ms_csr_tlbrd = ( ( mem_csr_num == `CSR_ASID || mem_csr_num == `CSR_TLBEHI) && (mem_csr_we)
+                     || ms_inst_tlbrd) && ms_valid;
 
 // exception
 
@@ -217,8 +221,4 @@ assign mem_final_result  = {32{ms_res_from_mem}} & ld_data |
 assign ms_mem_block = ( ms_res_from_mem || (mem_csr_re|mem_csr_we)) && ms_valid;     
 
 
-
-
-
-
 endmodule
diff --git a/MMU.v b/MMU.v
new file mode 100644
index 0000000..bdf065c
--- /dev/null
+++ b/MMU.v
@@ -0,0 +1,100 @@
+`include "CSR.vh"
+`include "BUS_LEN.vh"
+module MMU(
+    input wire  [1:0]                 flag,//10:inst;01:data
+    input wire  [31:0]                csr_crmd_rvalue,
+    input wire  [31:0]                csr_asid_rvalue,
+    input wire  [31:0]                csr_dmw0_rvalue,
+    input wire  [31:0]                csr_dmw1_rvalue,
+
+    // from tlb
+    input  wire                       s_found,
+    input  wire [ 3:0]                s_index,
+    input  wire [19:0]                s_ppn,
+    input  wire [ 5:0]                s_ps,
+    input  wire [ 1:0]                s_plv,
+    input  wire [ 1:0]                s_mat,
+    input  wire                       s_d,
+    input  wire                       s_v, 
+
+    //interface 
+    input wire [31:0]                 va,
+    output wire [5:0]                 exc_ecode,
+    output wire                       dmw_hit,
+    output wire [ 1:0]                plv,//10:adef,01:adem
+    output wire [31:0]                pa,
+    output wire [ 9:0]                s_asid
+);
+
+
+
+wire        csr_crmd_da;
+wire        csr_crmd_pg;
+wire [1:0]  csr_crmd_plv;
+wire [9:0]  csr_asid_asid;
+/*
+The legal combination of the DA bit and the PG bit is 0, 1, or 1, 0.
+*/
+assign csr_crmd_da = csr_crmd_rvalue[`CSR_CRMD_DA]; //Direct address translation mode enable
+assign csr_crmd_pg = csr_crmd_rvalue[`CSR_CRMD_PG]; //Mapped Address Translation Mode Enable
+assign csr_crmd_plv = csr_crmd_rvalue[`CSR_CRMD_PLV];//Current privilege level
+assign csr_asid_asid = csr_asid_rvalue[`CSR_ASID_ASID];//The address space identifier corresponding to the currently executing program
+
+wire        direct; //direct addr translation
+wire        dmw_hit0  ;
+wire        dmw_hit1  ;
+wire [31:0] dmw_paddr0;
+wire [31:0] dmw_paddr1;
+wire [31:0] tlb_paddr ;
+wire        tlb_trans;
+wire        ecode_pil ; //load Action Page Invalid Exception
+wire        ecode_pis ; //Store Operation Page Invalid Exception
+wire        ecode_pif ;//Invalid Finger Fetching Page Exception
+wire        ecode_pme ;//Page modification exceptions
+wire        ecode_ppi ;//Page Privilege Level Noncompliance Exception
+wire        ecode_tlbr;//TLB Refill Exception
+
+assign direct = csr_crmd_da & ~csr_crmd_pg;//direct addr translation
+/*
+The highest 3 bits of the virtual address ([31:29] bits) are the same as the [31:29] in the configuration window registers
+are equal and the current privilege level is allowed in this configuration window.
+*/
+assign dmw_hit0 = csr_dmw0_rvalue[csr_crmd_plv] && (csr_dmw0_rvalue[31:29] == va[31:29]); // csr_dmw_rvalue[31:29] = csr_dmw_vseg
+assign dmw_hit1 = csr_dmw1_rvalue[csr_crmd_plv] && (csr_dmw1_rvalue[31:29] == va[31:29]);
+/*
+When a virtual address hits a valid direct-mapped configuration window, 
+its physical address is directly equal to the [28:0] bits of the virtual address spliced onto the mapped window's
+Configured Physical Address High Bit
+*/
+assign dmw_paddr0 = {csr_dmw0_rvalue[`CSR_DMW_PSEG], va[28:0]}; 
+assign dmw_paddr1 = {csr_dmw1_rvalue[`CSR_DMW_PSEG], va[28:0]}; 
+/*
+Translating addresses addresses will be prioritized to see if 
+they can be translated according to the direct mapping model, 
+and then translated according to the page table mapping model after that.
+*/
+assign tlb_trans = ~dmw_hit0 & ~dmw_hit1 & ~direct;
+
+assign ecode_pif = flag[1] & tlb_trans & ~s_v;//only in IF stage
+assign ecode_ppi = tlb_trans & ((csr_crmd_plv > s_plv));//
+assign ecode_tlbr = tlb_trans & ~s_found;
+assign ecode_pil = flag[1]?1'b0:tlb_trans & ~s_v;
+assign ecode_pis = flag[1]?1'b0:tlb_trans & ~s_v;
+assign ecode_pme = flag[1]?1'b0:tlb_trans & ~s_d;
+
+
+//TODO:if it is direct ,it should also consider the error inst!
+assign exc_ecode = direct ? 6'b0 : {ecode_pil, ecode_pis, ecode_pif, ecode_pme, ecode_ppi, ecode_tlbr};
+assign tlb_paddr = (s_ps == 6'd12) ? {s_ppn[19:0], va[11:0]} : {s_ppn[19:10], va[21:0]};
+
+//paddr
+assign pa =       ({32{direct}} & va) | 
+                  ({32{~direct & dmw_hit0}} & dmw_paddr0) | 
+                  ({32{~direct & ~dmw_hit0 & dmw_hit1}} & dmw_paddr1) | 
+                  ({32{~direct & ~dmw_hit0 & ~dmw_hit1}} & tlb_paddr);
+                  
+assign s_asid = csr_asid_asid;
+assign dmw_hit = dmw_hit0 | dmw_hit1;
+assign plv = csr_crmd_plv;
+
+endmodule
diff --git a/WBstage.v b/WBstage.v
index bc7df54..11b1495 100644
--- a/WBstage.v
+++ b/WBstage.v
@@ -14,34 +14,20 @@ module WBstage (
 
     // interface with CSR
     output wire [`WS2CSR_BUS_LEN-1 : 0] ws2csr_bus    ,
-    input  wire [31:0] csr_rvalue,
+    input  wire [31:0]                  csr_rvalue,
 
     // to previous stages
     output wire                         ws_ex         ,
     output wire                         ws_ertn_flush ,
     output wire                         ws_reflush    ,
 
-
-    // exp18
-    input  wire  [ 3:0] csr_tlbidx_index, // from csr
-    // tlbrd
-    output wire         tlbrd_we, // to csr
-    output wire  [ 3:0] r_index,  // to tlb
-    // tlbwr and tlbfill, to tlb
-    output wire  [ 3:0] w_index,  // to tlb
-    output wire         we,       // to tlb
-    // tlbsrch, to csr
-    output wire         tlbsrch_we,         // to csr
-    output wire         tlbsrch_hit,        // to csr
-    output wire  [ 3:0] tlbsrch_hit_index,  // to csr
-
-
-
     // debug signal
     output wire [31:0]                  debug_wb_pc       ,
     output wire [3:0]                   debug_wb_rf_we    ,
     output wire [4:0]                   debug_wb_rf_wnum  ,
-    output wire [31:0]                  debug_wb_rf_wdata
+    output wire [31:0]                  debug_wb_rf_wdata ,
+    
+    output wire                         ws_csr_tlbrd
 
 );
 
@@ -55,6 +41,7 @@ wire          ws_inst_tlbwr;
 wire          ws_inst_tlbfill;
 wire          ws_tlbsrch_hit;
 wire [ 3:0]   ws_tlbsrch_hit_index;
+wire [ 5:0]   ws_exc_ecode;
 wire [31:0]   ws_pc;
 wire          ws_gr_we;
 wire [4:0]    ws_dest;
@@ -62,7 +49,8 @@ wire [31:0]   ws_final_result;
 wire [31: 0]  ws_rkd_value;
 wire [`MS_EXC_DATA_WD -1 : 0] ws_exc_data;
 reg  [`MS2WS_BUS_LEN -1 : 0]  ms2ws_bus_reg;
-assign {ws_refetch_flg,
+assign {ws_exc_ecode,
+        ws_refetch_flg,
         ws_inst_tlbsrch,
         ws_inst_tlbrd,
         ws_inst_tlbwr,
@@ -77,7 +65,9 @@ assign {ws_refetch_flg,
         ws_exc_data
         } = ms2ws_bus_reg;
 
-assign {ws_wrong_addr,    
+assign {
+        ws_csr_op,
+        ws_wrong_addr,    
         ws_csr_we,
         ws_csr_wmask,        
         ws_csr_num,       
@@ -107,7 +97,20 @@ wire         ws_ipi_int_in;
 wire  [31:0] ws_coreid_in;
 wire  [ 7:0] ws_hw_int_in;
 wire [31: 0] ws_wrong_addr;
-assign ws2csr_bus = {ws_csr_re, 
+//exp 18
+wire [3:0]  ws_csr_op;
+//exp 19
+wire [ 1:0] tlbwe_op;
+wire [19: 0]  ws_csr_tlb_ctrl;
+wire tlbsrch_we;
+wire tlbsrch_hit;
+wire [ 3:0] tlbsrch_hit_index;
+//TODO:Packaging wb-level to csr-level interaction pathways about TLBs
+assign ws_csr_tlb_ctrl = {tlbrd_we, tlbwe_op, tlbsrch_we, tlbsrch_hit, tlbsrch_hit_index};
+
+assign ws2csr_bus = {ws_csr_tlb_ctrl,
+                     ws_exc_ecode[0],
+                     ws_csr_re, 
                      ws_csr_we, 
                      ws_csr_num, 
                      ws_csr_wmask,
@@ -155,11 +158,6 @@ always @(posedge clk) begin
 end
 
 
-
-
-
-
-
 assign ws_csr_wvalue = ws_rkd_value;
 assign ws_reflush = ws_ertn_flush | ws_ex | ws_refetch_flg & ws_valid;
 
@@ -167,24 +165,14 @@ assign rf_we = ws_gr_we && ws_valid && ~ws_ex;
 assign rf_waddr = ws_dest;
 assign rf_wdata = ws_csr_re ? csr_rvalue : ws_final_result;
 
-
-// exp18
-reg  [ 3:0] rand_idx;
-always @ (posedge clk) begin
-    if (reset) begin
-        rand_idx <= 4'b0;
-    end else begin
-        rand_idx <= {rand_idx[1:0], 2'b0} + 4'd8; // 4*rand_idx+8 mod 16
-    end
-end
-
+//exp18
+wire tlbrd_we;
 // tlbrd
 assign tlbrd_we = ws_inst_tlbrd;
-assign r_index  = csr_tlbidx_index;
 
 // tlbwr and tlbfill
-assign w_index = ws_inst_tlbwr ? csr_tlbidx_index : rand_idx;
-assign we      = ws_inst_tlbwr | ws_inst_tlbfill;
+assign tlbwe_op[0] = ws_inst_tlbwr;
+assign tlbwe_op[1] = ws_inst_tlbfill;
 
 // tlbsrch
 assign tlbsrch_we         = ws_inst_tlbsrch;
@@ -192,7 +180,8 @@ assign tlbsrch_hit        = ws_tlbsrch_hit;
 assign tlbsrch_hit_index  = ws_tlbsrch_hit_index;
 
 
-
+assign ws_csr_tlbrd = ( ( ws_csr_num == `CSR_ASID || ws_csr_num == `CSR_TLBEHI) && (ws_csr_we)
+                     || ws_inst_tlbrd) && ws_valid;
 
 assign debug_wb_pc = ws_pc;
 assign debug_wb_rf_we = {4{rf_we}};
diff --git a/alu.v b/alu.v
index cf8f714..849409d 100644
--- a/alu.v
+++ b/alu.v
@@ -1,11 +1,11 @@
 module alu(
-  input clk,
-  input resetn,
-  input  wire [15:0] alu_op,
-  input  wire [31:0] alu_src1,
-  input  wire [31:0] alu_src2,
-  output wire [31:0] alu_result,
-  output wire        alu_flag
+  input               clk,
+  input               resetn,
+  input  wire [15:0]  alu_op,
+  input  wire [31:0]  alu_src1,
+  input  wire [31:0]  alu_src2,
+  output wire [31:0]  alu_result,
+  output wire         alu_flag
 );
 
 wire op_add;   //add operation
diff --git a/csr.v b/csr.v
index cbf4350..1d18d4a 100644
--- a/csr.v
+++ b/csr.v
@@ -16,53 +16,62 @@ module csr(
 
 
     // exp18
-    output reg  [ 9:0]      csr_asid_asid,
-    output reg  [18:0]      csr_tlbehi_vppn,
-    output reg  [ 3:0]      csr_tlbidx_index,
-
-    input  wire             tlbsrch_we,
-    input  wire             tlbsrch_hit,
-    input  wire             tlbrd_we,
-    input  wire [ 3:0]      tlbsrch_hit_index,
-    
-    input  wire             r_tlb_e,
-    input  wire [ 5:0]      r_tlb_ps,
-    input  wire [18:0]      r_tlb_vppn,
-    input  wire [ 9:0]      r_tlb_asid,
-    input  wire             r_tlb_g,
-
-    input  wire [19:0]      r_tlb_ppn0,
-    input  wire [ 1:0]      r_tlb_plv0,
-    input  wire [ 1:0]      r_tlb_mat0,
-    input  wire             r_tlb_d0,
-    input  wire             r_tlb_v0,
-
-    input  wire [19:0]      r_tlb_ppn1,
-    input  wire [ 1:0]      r_tlb_plv1,
-    input  wire [ 1:0]      r_tlb_mat1,
-    input  wire             r_tlb_d1,
-    input  wire             r_tlb_v1,
-
-    output wire             w_tlb_e,
-    output wire [ 5:0]      w_tlb_ps,
-    output wire [18:0]      w_tlb_vppn,
-    output wire [ 9:0]      w_tlb_asid,
-    output wire             w_tlb_g,
-
-    output wire [19:0]      w_tlb_ppn0,
-    output wire [ 1:0]      w_tlb_plv0,
-    output wire [ 1:0]      w_tlb_mat0,
-    output wire             w_tlb_d0,
-    output wire             w_tlb_v0,
-
-    output wire [19:0]      w_tlb_ppn1,
-    output wire [ 1:0]      w_tlb_plv1,
-    output wire [ 1:0]      w_tlb_mat1,
-    output wire             w_tlb_d1,
-    output wire             w_tlb_v1
+    output reg  [ 9:0]                  csr_asid_asid,
+    output reg  [18:0]                  csr_tlbehi_vppn,
+    output reg  [ 3:0]                  csr_tlbidx_index,
+
+
+
+    input  wire                         r_tlb_e,
+    input  wire [ 5:0]                  r_tlb_ps,
+    input  wire [18:0]                  r_tlb_vppn,
+    input  wire [ 9:0]                  r_tlb_asid,
+    input  wire                         r_tlb_g,
+
+    input  wire [19:0]                  r_tlb_ppn0,
+    input  wire [ 1:0]                  r_tlb_plv0,
+    input  wire [ 1:0]                  r_tlb_mat0,
+    input  wire                         r_tlb_d0,
+    input  wire                         r_tlb_v0,
+
+    input  wire [19:0]                  r_tlb_ppn1,
+    input  wire [ 1:0]                  r_tlb_plv1,
+    input  wire [ 1:0]                  r_tlb_mat1,
+    input  wire                         r_tlb_d1,
+    input  wire                         r_tlb_v1,
+
+    output wire                         w_tlb_e,
+    output wire [ 5:0]                  w_tlb_ps,
+    output wire [18:0]                  w_tlb_vppn,
+    output wire [ 9:0]                  w_tlb_asid,
+    output wire                         w_tlb_g,
+
+    output wire [19:0]                  w_tlb_ppn0,
+    output wire [ 1:0]                  w_tlb_plv0,
+    output wire [ 1:0]                  w_tlb_mat0,
+    output wire                         w_tlb_d0,
+    output wire                         w_tlb_v0,
+
+    output wire [19:0]                  w_tlb_ppn1,
+    output wire [ 1:0]                  w_tlb_plv1,
+    output wire [ 1:0]                  w_tlb_mat1,
+    output wire                         w_tlb_d1,
+    output wire                         w_tlb_v1,
+
+    output wire [ 3:0]                  r_index,
+    output wire [ 3:0]                  w_index,
+    output wire                         we,
+
+    // exp19
+    output wire [31:0]                  csr_crmd_rvalue,
+    output wire [31:0]                  csr_asid_rvalue,
+    output wire [31:0]                  csr_dmw0_rvalue,
+    output wire [31:0]                  csr_dmw1_rvalue  
 );
 
     //ws2csr_bus
+    wire [19:0] csr_tlb_ctrl;
+    wire        tlb_entry_en;
     wire        csr_re;
     wire        csr_we;
     wire [13:0] csr_num;
@@ -75,9 +84,34 @@ module csr(
     wire [31:0] coreid_in;
     wire [ 7:0] hw_int_in;
     wire [31:0] wb_vaddr;
-    assign {csr_re, csr_we, csr_num, csr_wmask, csr_wvalue, wb_pc, wb_ecode, wb_esubcode, ipi_int_in, coreid_in, hw_int_in, wb_vaddr} = ws2csr_bus;
+    
+    assign {csr_tlb_ctrl,tlb_entry_en, csr_re, csr_we, csr_num, csr_wmask, csr_wvalue, wb_pc, wb_ecode, wb_esubcode, ipi_int_in, coreid_in, hw_int_in, wb_vaddr} = ws2csr_bus;
+
+    // exp18
+    reg  [ 3:0] rand_idx;
+    always @ (posedge clk) begin
+        if (reset) begin
+            rand_idx <= 4'b0;
+        end else begin
+            rand_idx <= {rand_idx[1:0], 2'b0} + 4'd8; // 4*rand_idx+8 mod 16
+        end
+    end
 
-    // CRMD 当前模式信息
+    //exp18
+    wire we;
+    wire [ 3:0] w_index;
+    wire tlbrd_we;
+    wire [ 3:0]r_index;
+    wire [ 1:0]tlbwe_op;//10:tlbfill;01:tlbwrite
+    wire tlbsrch_we;
+    wire tlbsrch_hit;
+    wire [ 3:0]tlbsrch_hit_index;
+    assign {tlbrd_we, tlbwe_op, tlbsrch_we, tlbsrch_hit, tlbsrch_hit_index}=csr_tlb_ctrl;
+    assign we = |tlbwe_op;
+    assign r_index = csr_tlbidx_index;
+    assign w_index = {4{tlbwe_op[0]}}& csr_tlbidx_index | {4{tlbwe_op[1]}}& rand_idx;
+
+    // CRMD Current mode information
     wire [31: 0] csr_crmd_rvalue;
     reg  [ 1: 0] csr_crmd_plv;      //CRMD's PLV domain, current privilege level
     reg          csr_crmd_ie;       //CRMD's global interrupt enable signal
@@ -86,31 +120,31 @@ module csr(
     reg  [ 6: 5] csr_crmd_datf;
     reg  [ 8: 7] csr_crmd_datm;
 
-    // PRMD 例外前模式信�?
+    // PRMD  Pre-exception mode information
     wire [31: 0] csr_prmd_rvalue;
     reg  [ 1: 0] csr_prmd_pplv;     //Old value of CRMD's PLV field
     reg          csr_prmd_pie;      //Old value of CRMD's PIE field
 
-    // ESTAT 例外状�??
+    // ESTAT exceptional state
     wire [31: 0] csr_estat_rvalue;    
     reg  [12: 0] csr_estat_is;      // Status bits for exception interrupts, 8 hardware interrupts + 1 timer interrupt + 1 inter-core interrupt + 2 software interrupts)
     reg  [ 5: 0] csr_estat_ecode;   // Exception type level-1 code
     reg  [ 8: 0] csr_estat_esubcode;// Exception type level-2 code
 
-    // ERA 例外返回地址
+    // ERA Exception return address
     wire [31: 0] csr_era_rvalue;
     reg  [31: 0] csr_era_data;  
+    wire [31: 0] tlb_ex_entry;
+    assign ex_entry = tlb_entry_en? tlb_ex_entry:csr_eentry_rvalue;
+    assign tlb_ex_entry = csr_tlbrentry_rvalue;
 
-    assign ex_entry = csr_eentry_rvalue;
-    
-
-    // EENTRY 例外入口地址
+    // EENTRY Exception Entrance Address
     wire [31: 0] csr_eentry_rvalue;   
     reg  [25: 0] csr_eentry_va;     // Exception Interrupt Entry High Address
 
     assign ertn_entry = csr_era_rvalue;
     
-    // SAVE0-3 数据保存
+    // SAVE0-3 Data retention
     wire [31:0] csr_save0_rvalue;
     wire [31:0] csr_save1_rvalue;
     wire [31:0] csr_save2_rvalue;
@@ -123,33 +157,33 @@ module csr(
 
 
 
-    // ECFG 例外控制
+    // ECFG Exception control
     reg [12:0] csr_ecfg_lie;
     wire [31:0] csr_ecfg_rvalue;
     
-    // BADV 出错虚地�?
+    // BADV error virtual address 
     wire [31:0] csr_badv_rvalue;
     wire wb_ex_addr_err;
     reg [31:0] csr_badv_vaddr;
 
-    // TID 定时器编�?
+    // TID Timer ID
     wire [31:0] csr_tid_rvalue;
     reg [31:0] csr_tid_tid ;
 
 
-    // TCFG 定时器配�?
+    // TCFG Timer Configuration
     reg csr_tcfg_en ; 
     reg csr_tcfg_periodic ;
     reg [29:0] csr_tcfg_initval ;
     wire [31:0] csr_tcfg_rvalue ;
 
-    // TVAL 定时器数�?
+    // TVAL Timer value
     wire [31:0] tcfg_next_value ;
     reg  [31:0] timer_cnt ;
     wire [31:0] csr_tval_timeval;
     wire [31:0] csr_tval_rvalue ;
 
-    // TICLR 定时中断清除
+    // TICLR Timed interrupt clear
     wire csr_ticlr_clr ;
     wire [31:0] csr_ticlr_rvalue ;
 
@@ -187,6 +221,20 @@ module csr(
     // TLBRENTRY
     wire [31:0] csr_tlbrentry_rvalue;
     reg  [25:0] csr_tlbrentry_pa;
+    
+    
+     //DMW0-1
+    reg         csr_dmw0_plv0;
+    reg         csr_dmw0_plv3;
+    reg  [ 1:0] csr_dmw0_mat ;
+    reg  [ 2:0] csr_dmw0_pseg;
+    reg  [ 2:0] csr_dmw0_vseg;
+
+    reg         csr_dmw1_plv0;
+    reg         csr_dmw1_plv3;
+    reg  [ 1:0] csr_dmw1_mat ;
+    reg  [ 2:0] csr_dmw1_pseg;
+    reg  [ 2:0] csr_dmw1_vseg;
 
     // CRMD's PLV、IE field
     always @(posedge clk) begin
@@ -217,12 +265,21 @@ module csr(
             csr_crmd_pg   <= 1'b0;
             csr_crmd_datf <= 2'b0;
             csr_crmd_datm <= 2'b0;
-        end
-        else if (csr_we && csr_estat_ecode == 6'h3f) begin // ?
-            csr_crmd_da   <= 1'b0;
-            csr_crmd_pg   <= 1'b1;
-            csr_crmd_datf <= 2'b01;
-            csr_crmd_datm <= 2'b01;            
+        end else if (wb_ex && wb_ecode == `ECODE_TLBR) begin
+            csr_crmd_da <= 1'b1;
+            csr_crmd_pg <= 1'b0;
+        end else if (ertn_flush && csr_estat_ecode == `ECODE_TLBR) begin
+            csr_crmd_da <= 1'b0;
+            csr_crmd_pg <= 1'b1;
+        end else if (csr_we && csr_num == `CSR_CRMD) begin
+            csr_crmd_da <= csr_wmask[`CSR_CRMD_DA] & csr_wvalue[`CSR_CRMD_DA] |
+                          ~csr_wmask[`CSR_CRMD_DA] & csr_crmd_da;
+            csr_crmd_pg <= csr_wmask[`CSR_CRMD_PG] & csr_wvalue[`CSR_CRMD_PG] |
+                          ~csr_wmask[`CSR_CRMD_PG] & csr_crmd_pg;
+            csr_crmd_datf <= csr_wmask[`CSR_CRMD_DATF] & csr_wvalue[`CSR_CRMD_DATF] |
+                            ~csr_wmask[`CSR_CRMD_DATF] & csr_crmd_datf;
+            csr_crmd_datm <= csr_wmask[`CSR_CRMD_DATM] & csr_wvalue[`CSR_CRMD_DATM] |
+                            ~csr_wmask[`CSR_CRMD_DATM] & csr_crmd_datm;
         end
     end
 
@@ -328,7 +385,9 @@ module csr(
 
 
     // BADV
-    assign wb_ex_addr_err = wb_ecode==`ECODE_ADE || wb_ecode==`ECODE_ALE;
+    assign wb_ex_addr_err = wb_ecode == `ECODE_ADE || wb_ecode == `ECODE_ALE || wb_ecode == `ECODE_PIL
+                          || wb_ecode == `ECODE_PIS || wb_ecode == `ECODE_PIF || wb_ecode == `ECODE_PME
+                          || wb_ecode == `ECODE_PPI || wb_ecode == `ECODE_TLBR;
     always @(posedge clk) begin
         if (wb_ex && wb_ex_addr_err) begin
             csr_badv_vaddr <= (wb_ecode == `ECODE_ADE && 
@@ -419,7 +478,10 @@ module csr(
         if (reset) begin
             csr_tlbehi_vppn <= 19'b0;
         end else if (tlbrd_we) begin
-            csr_tlbehi_vppn <= r_tlb_e ? {19{r_tlb_e}} & r_tlb_vppn : 19'b0;
+            csr_tlbehi_vppn <= {19{r_tlb_e}} & r_tlb_vppn;
+        end else if(wb_ecode == `ECODE_PIL || wb_ecode == `ECODE_PIS || wb_ecode == `ECODE_PIF 
+             || wb_ecode == `ECODE_PME || wb_ecode == `ECODE_PPI || wb_ecode == `ECODE_TLBR) begin
+            csr_tlbehi_vppn <= wb_vaddr[31:13];
         end else if (csr_we && csr_num == `CSR_TLBEHI) begin
             csr_tlbehi_vppn <= csr_wmask[`CSR_TLBEHI_VPPN] & csr_wvalue[`CSR_TLBEHI_VPPN] |
                               ~csr_wmask[`CSR_TLBEHI_VPPN] & csr_tlbehi_vppn;
@@ -500,7 +562,53 @@ module csr(
     end
 
     assign csr_asid_asidbits = 8'd10;
+    
+    //DMW0-1
+    always @(posedge clk ) begin
+        if(reset) begin
+            csr_dmw0_plv0 <= 1'b0;
+            csr_dmw0_plv3 <= 1'b0;
+            csr_dmw0_mat  <= 2'b0;
+            csr_dmw0_pseg <= 3'b0;
+            csr_dmw0_vseg <= 3'b0;
+        end
+        else if(csr_we && csr_num == `CSR_DMW0)begin
+            csr_dmw0_plv0  <= csr_wmask[`CSR_DMW_PLV0] & csr_wvalue[`CSR_DMW_PLV0]
+                        | ~csr_wmask[`CSR_DMW_PLV0] & csr_dmw0_plv0; 
+            csr_dmw0_plv3  <= csr_wmask[`CSR_DMW_PLV3] & csr_wvalue[`CSR_DMW_PLV3]
+                        | ~csr_wmask[`CSR_DMW_PLV3] & csr_dmw0_plv3; 
+            csr_dmw0_mat   <= csr_wmask[`CSR_DMW_MAT] & csr_wvalue[`CSR_DMW_MAT]
+                        | ~csr_wmask[`CSR_DMW_MAT] & csr_dmw0_mat; 
+            csr_dmw0_pseg  <= csr_wmask[`CSR_DMW_PSEG] & csr_wvalue[`CSR_DMW_PSEG]
+                        | ~csr_wmask[`CSR_DMW_PSEG] & csr_dmw0_pseg;
+            csr_dmw0_vseg  <= csr_wmask[`CSR_DMW_VSEG] & csr_wvalue[`CSR_DMW_VSEG]
+                        | ~csr_wmask[`CSR_DMW_VSEG] & csr_dmw0_vseg;   
+        end
+    end
 
+    always @(posedge clk ) begin
+        if(reset) begin
+            csr_dmw1_plv0 <= 1'b0;
+            csr_dmw1_plv3 <= 1'b0;
+            csr_dmw1_mat  <= 2'b0;
+            csr_dmw1_pseg <= 3'b0;
+            csr_dmw1_vseg <= 3'b0;
+        end
+        else if(csr_we && csr_num == `CSR_DMW1)begin
+            csr_dmw1_plv0  <= csr_wmask[`CSR_DMW_PLV0] & csr_wvalue[`CSR_DMW_PLV0]
+                        | ~csr_wmask[`CSR_DMW_PLV0] & csr_dmw1_plv0; 
+            csr_dmw1_plv3  <= csr_wmask[`CSR_DMW_PLV3] & csr_wvalue[`CSR_DMW_PLV3]
+                        | ~csr_wmask[`CSR_DMW_PLV3] & csr_dmw1_plv3; 
+            csr_dmw1_mat   <= csr_wmask[`CSR_DMW_MAT] & csr_wvalue[`CSR_DMW_MAT]
+                        | ~csr_wmask[`CSR_DMW_MAT] & csr_dmw1_mat; 
+            csr_dmw1_pseg  <= csr_wmask[`CSR_DMW_PSEG] & csr_wvalue[`CSR_DMW_PSEG]
+                        | ~csr_wmask[`CSR_DMW_PSEG] & csr_dmw1_pseg;
+            csr_dmw1_vseg  <= csr_wmask[`CSR_DMW_VSEG] & csr_wvalue[`CSR_DMW_VSEG]
+                        | ~csr_wmask[`CSR_DMW_VSEG] & csr_dmw1_vseg;   
+        end
+    end
+
+    
     // TLBRENTRY
     always @ (posedge clk) begin
         if (reset) begin
@@ -536,6 +644,9 @@ module csr(
     assign csr_tlbelo1_rvalue = {csr_tlbelo1_ppn, 1'b0, csr_tlbelo1_g, csr_tlbelo1_mat, csr_tlbelo1_plv, csr_tlbelo1_d, csr_tlbelo1_v};
     assign csr_asid_rvalue = {8'b0, csr_asid_asidbits, 6'b0, csr_asid_asid};
     assign csr_tlbrentry_rvalue = {csr_tlbrentry_pa, 6'b0};
+    //exp19
+    assign csr_dmw0_rvalue = {csr_dmw0_vseg, 1'b0, csr_dmw0_pseg, 19'b0, csr_dmw0_mat, csr_dmw0_plv3, 2'b0, csr_dmw0_plv0};
+    assign csr_dmw1_rvalue = {csr_dmw1_vseg, 1'b0, csr_dmw1_pseg, 19'b0, csr_dmw1_mat, csr_dmw1_plv3, 2'b0, csr_dmw1_plv0};
 
     assign csr_rvalue =   {32{csr_num == `CSR_CRMD  }} & csr_crmd_rvalue
                         | {32{csr_num == `CSR_PRMD  }} & csr_prmd_rvalue
@@ -557,7 +668,9 @@ module csr(
                         | {32{csr_num == `CSR_TLBELO0}} & csr_tlbelo0_rvalue
                         | {32{csr_num == `CSR_TLBELO1}} & csr_tlbelo1_rvalue
                         | {32{csr_num == `CSR_ASID  }} & csr_asid_rvalue
-                        | {32{csr_num == `CSR_TLBRENTRY}} & csr_tlbrentry_rvalue;
+                        | {32{csr_num == `CSR_TLBRENTRY}} & csr_tlbrentry_rvalue
+                        | {32{csr_num == `CSR_DMW0  }} & csr_dmw0_rvalue
+                        | {32{csr_num == `CSR_DMW1  }} & csr_dmw1_rvalue;
     
     assign has_int = ((csr_estat_is[11:0] & csr_ecfg_lie[11:0]) != 12'b0) && (csr_crmd_ie == 1'b1);
 
diff --git a/div.v b/div.v
index eddfe05..3100167 100644
--- a/div.v
+++ b/div.v
@@ -1,27 +1,27 @@
 module DIV(
-    input  wire    clk,
-    input  wire    resetn,
-    input  wire    div_en,
-    input  wire    sign,
-    input  wire [31:0] divisor,   
-    input  wire [31:0] dividend,  
-    output wire [63:0] result,
-    output wire    complete 
+    input  wire                 clk,
+    input  wire                 resetn,
+    input  wire                 div_en,
+    input  wire                 sign,
+    input  wire [31:0]          divisor,   
+    input  wire [31:0]          dividend,  
+    output wire [63:0]          result,
+    output wire                 complete 
 );
 
-    wire [31:0] quotient;
-    wire [31:0] remainder;
-    wire        sign_s;
-    wire        sign_r;
-    wire [31:0] divisor_abs;
-    wire [31:0] dividend_y;
-    wire [32:0] pre_r;
-    wire [32:0] recover_r;
-    reg  [63:0] divisor_pad;
-    reg  [32:0] dividend_pad;
-    reg  [31:0] quotient_reg;
-    reg  [32:0] remainder_reg;    
-    reg  [ 5:0] counter;
+    wire [31:0]                 quotient;
+    wire [31:0]                 remainder;
+    wire                        sign_s;
+    wire                        sign_r;
+    wire [31:0]                 divisor_abs;
+    wire [31:0]                 dividend_y;
+    wire [32:0]                 pre_r;
+    wire [32:0]                 recover_r;
+    reg  [63:0]                 divisor_pad;
+    reg  [32:0]                 dividend_pad;
+    reg  [31:0]                 quotient_reg;
+    reg  [32:0]                 remainder_reg;    
+    reg  [ 5:0]                 counter;
 
     assign sign_s = (divisor[31]^dividend[31]) & sign;
     assign sign_r = divisor[31] & sign;
diff --git a/mul.v b/mul.v
index 004e084..4711c3c 100644
--- a/mul.v
+++ b/mul.v
@@ -19,15 +19,15 @@
 // 
 //////////////////////////////////////////////////////////////////////////////////
 
-//booth˷ģ
+
 module booth_multiplier(
     input clk,
-    input  [33:0] x, //
-    input  [33:0] y, //
-    output reg [67:0] z  //˻
+    input  [33:0] x, 
+    input  [33:0] y,
+    output reg [67:0] z  
 );
 
-//ɲֻpartial product generator, ppg
+
 wire [67:0] ppg_p [16:0];
 wire [16:0] ppg_c;
 
@@ -43,7 +43,7 @@ generate
     end
 endgenerate
 
-//ʿwallace tree, wt
+
 wire [14:0] wt_cio [68:0];
 wire [67:0] wt_c;
 wire [67:0] wt_s;
@@ -75,20 +75,20 @@ wire [67:0] z_temp;
 always@ (posedge clk) begin
     z <= z_temp;
 end
-//64λӷ
+
 assign z_temp = {wt_c[66:0], ppg_c[15]} + wt_s[67:0] + ppg_c[16];
 
 endmodule
 
 
-//ֻģ
+
 module partial_product_generator #(
     parameter XWIDTH = 68
 )(
-    input  [XWIDTH-1:0] x, //
-    input  [       2:0] y, //y_{i+1}, y_{i}, y_{i-1}
-    output [XWIDTH-1:0] p, //ֻ
-    output              c  //λ
+    input  [XWIDTH-1:0] x, 
+    input  [       2:0] y,
+    output [XWIDTH-1:0] p, 
+    output              c  
 );
 
 wire sn;
@@ -114,13 +114,13 @@ assign c = sn | sn2;
 endmodule
 
 
-//һȫģ
+
 module one_bit_adder(
-    input  a,   //
-    input  b,   //
-    input  c,   //λ
-    output s,   //
-    output cout //λ
+    input  a,   
+    input  b,  
+    input  c,   
+    output s,   
+    output cout 
 );
 
 assign s = ~(~(a&~b&~c) & ~(~a&b&~c) & ~(~a&~b&c) & ~(a&b&c));
@@ -129,13 +129,13 @@ assign cout = a&b | a&c | b&c;
 endmodule
 
 
-//ʿģ
+
 module wallace_tree(
-    input  [16:0] n,    //
-    input  [14:0] cin,  //λ
-    output [14:0] cout, //λ
-    output        c,    //λ
-    output        s     //
+    input  [16:0] n,    
+    input  [14:0] cin,  
+    output [14:0] cout, 
+    output        c,   
+    output        s   
 );
 
 wire [15:0] adder_a;
diff --git a/mycpu_core.v b/mycpu_core.v
index 3b14696..b8fe1b9 100644
--- a/mycpu_core.v
+++ b/mycpu_core.v
@@ -1,35 +1,35 @@
 `include "BUS_LEN.vh"
 module mycpu_core (
-    input  wire        clk,
-    input  wire        resetn,
-
-    // inst sram interface
-    output wire        inst_sram_req,
-    output wire        inst_sram_wr,
-    output wire [ 1:0] inst_sram_size,
-    output wire [ 3:0] inst_sram_wstrb,
-    output wire [31:0] inst_sram_addr,
-    output wire [31:0] inst_sram_wdata,
-    input  wire [31:0] inst_sram_rdata,
-    input  wire        inst_sram_addr_ok,
-    input  wire        inst_sram_data_ok,
-
-    // data sram interface
-    output wire        data_sram_req,
-    output wire        data_sram_wr,
-    output wire [ 3:0] data_sram_wstrb,
-    output wire [ 1:0] data_sram_size,
-    output wire [31:0] data_sram_addr,
-    output wire [31:0] data_sram_wdata,
-    input  wire [31:0] data_sram_rdata,
-    input  wire        data_sram_addr_ok,
-    input  wire        data_sram_data_ok,
-
-    // trace debug interface
-    output wire [31:0] debug_wb_pc,
-    output wire [ 3:0] debug_wb_rf_we,
-    output wire [ 4:0] debug_wb_rf_wnum,
-    output wire [31:0] debug_wb_rf_wdata
+    input  wire                         clk,
+    input  wire                         resetn,
+
+    // inst sram interf                 ace
+    output wire                         inst_sram_req,
+    output wire                         inst_sram_wr,
+    output wire [ 1:0]                  inst_sram_size,
+    output wire [ 3:0]                  inst_sram_wstrb,
+    output wire [31:0]                  inst_sram_addr,
+    output wire [31:0]                  inst_sram_wdata,
+    input  wire [31:0]                  inst_sram_rdata,
+    input  wire                         inst_sram_addr_ok,
+    input  wire                         inst_sram_data_ok,
+
+    // data sram interf                 ace
+    output wire                         data_sram_req,
+    output wire                         data_sram_wr,
+    output wire [ 3:0]                  data_sram_wstrb,
+    output wire [ 1:0]                  data_sram_size,
+    output wire [31:0]                  data_sram_addr,
+    output wire [31:0]                  data_sram_wdata,
+    input  wire [31:0]                  data_sram_rdata,
+    input  wire                         data_sram_addr_ok,
+    input  wire                         data_sram_data_ok,
+
+    // trace debug inte                 rface
+    output wire [31:0]                  debug_wb_pc,
+    output wire [ 3:0]                  debug_wb_rf_we,
+    output wire [ 4:0]                  debug_wb_rf_wnum,
+    output wire [31:0]                  debug_wb_rf_wdata
 );
 
 reg         reset;
@@ -48,18 +48,18 @@ wire ms2ws_valid;
 
 wire [`FORWARD_BUS_LEN-1:0] exe_forward_zip;
 wire [`FORWARD_BUS_LEN-1:0] mem_forward_zip;
-wire [`BR_BUS-1:0] br_zip;
-wire [`WB_RF_BUS-1:0] rf_zip;
-
-wire es_block;
-wire es_mem_block;
-wire ms_mem_block;
-wire mul_block;
-
-wire [`FS2DS_BUS_LEN-1:0]     fs2ds_bus;
-wire [`DS2ES_BUS_LEN-1:0]     ds2es_bus;
-wire [`ES2MS_BUS_LEN-1:0]     es2ms_bus;
-wire [`MS2WS_BUS_LEN-1:0]     ms2ws_bus;
+wire [`BR_BUS-1:0]          br_zip;
+wire [`WB_RF_BUS-1:0]       rf_zip;
+
+wire  es_block;
+wire  es_mem_block;
+wire  ms_mem_block;
+wire  mul_block;
+
+wire [`FS2DS_BUS_LEN -1:0]     fs2ds_bus;
+wire [`DS2ES_BUS_LEN -1:0]     ds2es_bus;
+wire [`ES2MS_BUS_LEN -1:0]     es2ms_bus;
+wire [`MS2WS_BUS_LEN -1:0]     ms2ws_bus;
 wire [`WS2CSR_BUS_LEN-1:0]    ws2csr_bus;
 
 wire [67:0] mul_result;
@@ -85,10 +85,11 @@ wire [18:0] csr_tlbehi_vppn;
 wire [ 3:0] csr_tlbidx_index;
 
 wire        ms_csr_tlbrd;
+wire        ws_csr_tlbrd;
 
-wire tlbrd_we;
-wire tlbsrch_we;
-wire tlbsrch_hit;
+wire        tlbrd_we;
+wire        tlbsrch_we;
+wire        tlbsrch_hit;
 wire [ 3:0] tlbsrch_hit_index;
 
 // TLB ports
@@ -150,309 +151,380 @@ wire [ 1:0] r_mat1;
 wire        r_d1;
 wire        r_v1;
 
+wire [19:0] s0_va_highbits;
+wire [ 9:0] s0_asid;
 
-
-
-
-
+//exp 19
+wire [31:0] csr_crmd_rvalue;
+wire [31:0] csr_asid_rvalue;
+wire [31:0] csr_dmw0_rvalue;
+wire [31:0] csr_dmw1_rvalue;
+
+wire[31:0] fs_va;
+wire[31:0] fs_pa;
+wire[9 :0] fs_asid;
+wire[5 :0] fs_exc_ecode;
+wire[5 :0] es_exc_ecode;
+
+wire[1 :0] fs_plv;
+wire       fs_dmwhit;
+wire[31:0] es_va;
+wire[31:0] es_pa;
+wire[1 :0] es_plv;
+wire       es_dmwhit;
+wire[1 :0] es_mmu_en;
 
 IFstage my_if (
-    .clk              (clk),
-    .resetn           (resetn),
-    
-    .inst_sram_en     (inst_sram_req    ),
-    .inst_sram_wr     (inst_sram_wr     ),
-    .inst_sram_we     (inst_sram_wstrb  ),
-    .inst_sram_size   (inst_sram_size   ),
-    .inst_sram_addr   (inst_sram_addr   ),
-    .inst_sram_wdata  (inst_sram_wdata  ),
-    .inst_sram_rdata  (inst_sram_rdata  ),
-    .inst_sram_addr_ok(inst_sram_addr_ok),
-    .inst_sram_data_ok(inst_sram_data_ok),
-    
-    .br_zip           (br_zip),
-    .fs2ds_bus        (fs2ds_bus),
-    .ds_allowin       (ds_allowin),
-    .fs2ds_valid      (fs2ds_valid),
-    
-    .csr_ex_entry     (csr_ex_entry  ),
-    .csr_ertn_entry   (csr_ertn_entry),
-    .ertn_flush       (ertn_flush),
-    .wb_ex            (wb_ex     ),
-
-    .fs_reflush       (ws_reflush)
+    .clk                    (clk),
+    .resetn                 (resetn),
+
+    .inst_sram_en           (inst_sram_req    ),
+    .inst_sram_wr           (inst_sram_wr     ),
+    .inst_sram_we           (inst_sram_wstrb  ),
+    .inst_sram_size         (inst_sram_size   ),
+    .inst_sram_addr         (inst_sram_addr   ),
+    .inst_sram_wdata        (inst_sram_wdata  ),
+    .inst_sram_rdata        (inst_sram_rdata  ),
+    .inst_sram_addr_ok      (inst_sram_addr_ok),
+    .inst_sram_data_ok      (inst_sram_data_ok),
+
+    .br_zip                 (br_zip),
+    .fs2ds_bus              (fs2ds_bus),
+    .ds_allowin             (ds_allowin),
+    .fs2ds_valid            (fs2ds_valid),
+
+    .csr_ex_entry           (csr_ex_entry  ),
+    .csr_ertn_entry         (csr_ertn_entry),
+    .ertn_flush             (ertn_flush),
+    .wb_ex                  (wb_ex     ),
+    .fs_reflush             (ws_reflush),
+
+    .s0_va_highbits         ({s0_vppn, s0_va_bit12}),/*TODO:Note that these two lines should have been placed in the MMU module as well, 
+                                            to ensure that the tlb and pipeline stages are completely isolated, i.e., IF decoding is handled entirely by the MMU, 
+                                            but the EXE address translation reuses a bit of the tlb instruction datapath, 
+                                            so it's not good for compatibility, and so for now, it's still placed here.EXE is same.*/
+    .s0_asid                (s0_asid), 
+
+    //mmu module
+    .va                     (fs_va),
+    .pa                     (fs_pa),
+    .plv                    (fs_plv),
+    .dmw_hit                (fs_dmwhit),
+    .mmu_asid               (fs_asid),
+    .fs_exc_ecode           (fs_exc_ecode)
 );
 
+MMU IF_mmu(
+  .flag(2'b10),
+  
+  .csr_crmd_rvalue          (csr_crmd_rvalue),
+  .csr_asid_rvalue          (csr_asid_rvalue),
+  .csr_dmw0_rvalue          (csr_dmw0_rvalue),
+  .csr_dmw1_rvalue          (csr_dmw1_rvalue),
+
+  .s_found                  (s0_found),
+  .s_index                  (s0_index),
+  .s_ppn                    (s0_ppn),
+  .s_ps                     (s0_ps),
+  .s_plv                    (s0_plv),
+  .s_mat                    (s0_mat),
+  .s_d                      (s0_d),
+  .s_v                      (s0_v),
+  
+    //mmu module
+  .dmw_hit                  (fs_dmwhit),
+  .plv                      (fs_plv),
+  .va                       (fs_va),
+  .exc_ecode                (fs_exc_ecode),
+  .s_asid                   (fs_asid),
+  .pa                       (fs_pa)
+);
 
 IDstage my_id (
-    .clk              (clk),
-    .reset            (reset),
-    
-    .es_allowin       (es_allowin),
-    .ds_allowin       (ds_allowin),
-    .fs2ds_valid      (fs2ds_valid),
-    .ds2es_valid      (ds2es_valid),
-
-    .br_zip           (br_zip),
-    .ds2es_bus        (ds2es_bus),
-    .fs2ds_bus        (fs2ds_bus),
-
-    .mem_forward_zip  (mem_forward_zip),
-    .exe_forward_zip  (exe_forward_zip),
-    .rf_zip           (rf_zip),
-
-    .es_block         (es_block),
-    .es_mem_block     (es_mem_block),
-    .ms_mem_block     (ms_mem_block),
-    .mul_block            (mul_block),
-
-    .ms_csr_re        (ms_csr_re),
-    .es_csr_re        (es_csr_re),
-    .ds_has_int       (csr_has_int),
-    .ds_reflush       (ws_reflush)
+    .clk                    (clk),
+    .reset                  (reset),
+
+    .es_allowin             (es_allowin),
+    .ds_allowin             (ds_allowin),
+    .fs2ds_valid            (fs2ds_valid),
+    .ds2es_valid            (ds2es_valid),
+
+    .br_zip                 (br_zip),
+    .ds2es_bus              (ds2es_bus),
+    .fs2ds_bus              (fs2ds_bus),
+
+    .mem_forward_zip        (mem_forward_zip),
+    .exe_forward_zip        (exe_forward_zip),
+    .rf_zip                 (rf_zip),
+
+    .es_block               (es_block),
+    .es_mem_block           (es_mem_block),
+    .ms_mem_block           (ms_mem_block),
+    .mul_block                  (mul_block),
+
+    .ms_csr_re              (ms_csr_re),
+    .es_csr_re              (es_csr_re),
+    .ds_has_int             (csr_has_int),
+    .ds_reflush             (ws_reflush)
 );
 
 
 EXEstage my_exe (
-    .clk              (clk),
-    .resetn           (resetn),
-    .reset            (reset),
+    .clk                    (clk),
+    .resetn                 (resetn),
+    .reset                  (reset),
+
+    .ms_allowin             (ms_allowin),
+    .es_allowin             (es_allowin),
+    .ds2es_valid            (ds2es_valid),
+    .es2ms_valid            (es2ms_valid),
+
+    .ds2es_bus              (ds2es_bus),
+    .es2ms_bus              (es2ms_bus),
+
+    .data_sram_en           (data_sram_req    ),
+    .data_sram_wr           (data_sram_wr     ),
+    .data_sram_we           (data_sram_wstrb  ),     
+    .data_sram_size         (data_sram_size   ),
+    .data_sram_addr         (data_sram_addr   ),
+    .data_sram_wdata        (data_sram_wdata  ),
+    .data_sram_addr_ok      (data_sram_addr_ok),
+
+    .exe_forward_zip        (exe_forward_zip),
+
+    .es_block               (es_block),
+    .es_mem_block           (es_mem_block),
+    .mul_block              (mul_block),
+
+    .mul_result             (mul_result),
+
+    .ms_ex_to_es            (ms_ex_to_es),
+    .es_csr_re              (es_csr_re),
+    .es_reflush             (ws_reflush),
+
+    // exp 18       
+    .s1_va_highbits         ({s1_vppn, s1_va_bit12}),
+    .s1_asid                (s1_asid),
+    .invtlb_valid           (invtlb_valid),
+    .invtlb_op              (invtlb_op),
+    .s1_found               (s1_found),
+    .s1_index               (s1_index),
+    .csr_asid_asid          (csr_asid_asid),
+    .csr_tlbehi_vppn        (csr_tlbehi_vppn),
+    .ms_csr_tlbrd           (ms_csr_tlbrd),
+    .ws_csr_tlbrd           (ws_csr_tlbrd),
+    // exp 19
+    .es_exc_ecode           (es_exc_ecode),
+    .dmw_hit                (es_dmwhit),
+    .plv                    (es_plv),
+    .va                     (es_va),
+    .pa                     (es_pa),
+    .mmu_en                 (es_mmu_en)
+);
+
+MMU EXE_mmu(
+    .flag                   (es_mmu_en),
+    .csr_crmd_rvalue        (csr_crmd_rvalue),
+    .csr_asid_rvalue        (csr_asid_rvalue),
+    .csr_dmw0_rvalue        (csr_dmw0_rvalue),
+    .csr_dmw1_rvalue        (csr_dmw1_rvalue),
     
-    .ms_allowin       (ms_allowin),
-    .es_allowin       (es_allowin),
-    .ds2es_valid      (ds2es_valid),
-    .es2ms_valid      (es2ms_valid),
+    .s_found                (s1_found),
+    .s_index                (s1_index),
+    .s_ppn                  (s1_ppn),
+    .s_ps                   (s1_ps),
+    .s_plv                  (s1_plv),
+    .s_mat                  (s1_mat),
+    .s_d                    (s1_d),
+    .s_v                    (s1_v),
     
-    .ds2es_bus        (ds2es_bus),
-    .es2ms_bus        (es2ms_bus),
-
-    .data_sram_en     (data_sram_req    ),
-    .data_sram_wr     (data_sram_wr     ),
-    .data_sram_we     (data_sram_wstrb  ),     
-    .data_sram_size   (data_sram_size   ),
-    .data_sram_addr   (data_sram_addr   ),
-    .data_sram_wdata  (data_sram_wdata  ),
-    .data_sram_addr_ok(data_sram_addr_ok),
-
-    .exe_forward_zip  (exe_forward_zip),
-
-    .es_block         (es_block),
-    .es_mem_block     (es_mem_block),
-    .mul_block            (mul_block),
-
-    .mul_result       (mul_result),
-
-    .ms_ex_to_es      (ms_ex_to_es),
-    .es_csr_re        (es_csr_re),
-    .es_reflush       (ws_reflush),
-
-
-
-    // exp 18
-    .s1_va_highbits   ({s1_vppn, s1_va_bit12}),
-    .s1_asid          (s1_asid),
-    .invtlb_valid     (invtlb_valid),
-    .invtlb_op        (invtlb_op),
-    .csr_asid_asid    (csr_asid_asid),
-    .csr_tlbehi_vppn  (csr_tlbehi_vppn),
-    .ms_csr_tlbrd     (ms_csr_tlbrd)
+    .va                     (es_va),
+    .exc_ecode              (es_exc_ecode),
+    .dmw_hit                (es_dmwhit),
+    .plv                    (es_plv),
+    .pa                     (es_pa)
 );
 
-
 MEMstage my_mem (
-    .clk              (clk),
-    .resetn           (resetn),
-    .reset            (reset),
+    .clk                    (clk),
+    .resetn                 (resetn),
+    .reset                  (reset),
 
-    .data_sram_rdata (data_sram_rdata ),
-    .data_sram_data_ok(data_sram_data_ok),
+    .data_sram_rdata        (data_sram_rdata ),
+    .data_sram_data_ok      (data_sram_data_ok),
     
-    .ws_allowin       (ws_allowin),
-    .ms_allowin       (ms_allowin),
-    .es2ms_valid      (es2ms_valid),
-    .ms2ws_valid      (ms2ws_valid),
-    
-    .es2ms_bus        (es2ms_bus),
-    .ms2ws_bus        (ms2ws_bus),
-    .mem_forward_zip  (mem_forward_zip),
-
-    .mul_result       (mul_result),
-    .ms_mem_block     (ms_mem_block),
-    .ms_ex_to_es      (ms_ex_to_es),
-    .ms_reflush       (ws_reflush),
-    .ms_csr_re        (ms_csr_re),
-
-
-    // exp 18
-    .s1_found        (s1_found),
-    .s1_index        (s1_index),
-    .ms_csr_tlbrd    (ms_csr_tlbrd)
+    .ws_allowin             (ws_allowin),
+    .ms_allowin             (ms_allowin),
+    .es2ms_valid            (es2ms_valid),
+    .ms2ws_valid            (ms2ws_valid),
+
+    .es2ms_bus              (es2ms_bus),
+    .ms2ws_bus              (ms2ws_bus),
+    .mem_forward_zip        (mem_forward_zip),
+
+    .mul_result             (mul_result),
+    .ms_mem_block           (ms_mem_block),
+    .ms_ex_to_es            (ms_ex_to_es),
+    .ms_reflush             (ws_reflush),
+    .ms_csr_re              (ms_csr_re),
+
+    .ms_csr_tlbrd           (ms_csr_tlbrd)
 );
 
 
 WBstage my_wb (
-    .clk              (clk),
-    .resetn           (resetn),
-    .reset            (reset),
+    .clk                    (clk),
+    .resetn                 (resetn),
+    .reset                  (reset),
+
+    .ws_allowin             (ws_allowin),
+    .ms2ws_valid            (ms2ws_valid),
+
+    .ms2ws_bus              (ms2ws_bus),
+    .rf_zip                 (rf_zip),
+
+    .debug_wb_pc            (debug_wb_pc),
+    .debug_wb_rf_we         (debug_wb_rf_we),
+    .debug_wb_rf_wnum       (debug_wb_rf_wnum),
+    .debug_wb_rf_wdata      (debug_wb_rf_wdata),
+
+    .csr_rvalue             (csr_rvalue),
+    .ws_ertn_flush          (ertn_flush),
+    .ws_reflush             (ws_reflush),
+    .ws_ex                  (wb_ex),
+    .ws2csr_bus             (ws2csr_bus),
     
-    .ws_allowin       (ws_allowin),
-    .ms2ws_valid      (ms2ws_valid),
-    
-    .ms2ws_bus        (ms2ws_bus),
-    .rf_zip           (rf_zip),
-
-    .debug_wb_pc      (debug_wb_pc),
-    .debug_wb_rf_we   (debug_wb_rf_we),
-    .debug_wb_rf_wnum (debug_wb_rf_wnum),
-    .debug_wb_rf_wdata(debug_wb_rf_wdata),
+    .ws_csr_tlbrd           (ws_csr_tlbrd)
 
-    .csr_rvalue       (csr_rvalue),
-    .ws_ertn_flush       (ertn_flush),
-    .ws_reflush       (ws_reflush),
-    .ws_ex            (wb_ex),
-    .ws2csr_bus       (ws2csr_bus),
-
-
-
-    // exp 18
-    .r_index         (r_index),
-    .tlbrd_we        (tlbrd_we),
-    .csr_tlbidx_index(csr_tlbidx_index),
-
-    .w_index         (w_index),
-    .we              (we),
-    
-    .tlbsrch_we      (tlbsrch_we),
-    .tlbsrch_hit     (tlbsrch_hit),
-    .tlbsrch_hit_index(tlbsrch_hit_index)
 );
 
 
 csr u_csr(
-    .clk            (clk       ),
-    .reset          (reset   ),
-    .csr_rvalue     (csr_rvalue),
-    .ex_entry       (csr_ex_entry  ),
-    .ertn_entry     (csr_ertn_entry),
-    .ertn_flush     (ertn_flush),
-    .wb_ex          (wb_ex     ),
-    .ws2csr_bus     (ws2csr_bus),
-    .has_int        (csr_has_int),
-
-
+    .clk                    (clk       ),
+    .reset                  (reset   ),
+    .csr_rvalue             (csr_rvalue),
+    .ex_entry               (csr_ex_entry  ),
+    .ertn_entry             (csr_ertn_entry),
+    .ertn_flush             (ertn_flush),
+    .wb_ex                  (wb_ex     ),
+    .ws2csr_bus             (ws2csr_bus),
+    .has_int                (csr_has_int),
 
     // exp 18
-    .csr_asid_asid   (csr_asid_asid),
-    .csr_tlbehi_vppn (csr_tlbehi_vppn),
-    .csr_tlbidx_index(csr_tlbidx_index),
-
-    .tlbsrch_we        (tlbsrch_we),
-    .tlbsrch_hit       (tlbsrch_hit),
-    .tlbsrch_hit_index (tlbsrch_hit_index),
-    .tlbrd_we          (tlbrd_we),
-
-    .r_tlb_e         (r_e),
-    .r_tlb_ps        (r_ps),
-    .r_tlb_vppn      (r_vppn),
-    .r_tlb_asid      (r_asid),
-    .r_tlb_g         (r_g),
-    .r_tlb_ppn0      (r_ppn0),
-    .r_tlb_plv0      (r_plv0),
-    .r_tlb_mat0      (r_mat0),
-    .r_tlb_d0        (r_d0),
-    .r_tlb_v0        (r_v0),
-    .r_tlb_ppn1      (r_ppn1),
-    .r_tlb_plv1      (r_plv1),
-    .r_tlb_mat1      (r_mat1),
-    .r_tlb_d1        (r_d1),
-    .r_tlb_v1        (r_v1),
-
-    .w_tlb_e         (w_e),
-    .w_tlb_ps        (w_ps),
-    .w_tlb_vppn      (w_vppn),
-    .w_tlb_asid      (w_asid),
-    .w_tlb_g         (w_g),
-    .w_tlb_ppn0      (w_ppn0),
-    .w_tlb_plv0      (w_plv0),
-    .w_tlb_mat0      (w_mat0),
-    .w_tlb_d0        (w_d0),
-    .w_tlb_v0        (w_v0),
-    .w_tlb_ppn1      (w_ppn1),
-    .w_tlb_plv1      (w_plv1),
-    .w_tlb_mat1      (w_mat1),
-    .w_tlb_d1        (w_d1),
-    .w_tlb_v1        (w_v1)
+    .csr_asid_asid          (csr_asid_asid),
+    .csr_tlbehi_vppn        (csr_tlbehi_vppn),
+
+    .w_index                (w_index),
+    .we                     (we),
+    .r_index                (r_index),
+
+    .r_tlb_e                (r_e),
+    .r_tlb_ps               (r_ps),
+    .r_tlb_vppn             (r_vppn),
+    .r_tlb_asid             (r_asid),
+    .r_tlb_g                (r_g),
+    .r_tlb_ppn0             (r_ppn0),
+    .r_tlb_plv0             (r_plv0),
+    .r_tlb_mat0             (r_mat0),
+    .r_tlb_d0               (r_d0),
+    .r_tlb_v0               (r_v0),
+    .r_tlb_ppn1             (r_ppn1),
+    .r_tlb_plv1             (r_plv1),
+    .r_tlb_mat1             (r_mat1),
+    .r_tlb_d1               (r_d1),
+    .r_tlb_v1               (r_v1),
+
+    .w_tlb_e                (w_e),
+    .w_tlb_ps               (w_ps),
+    .w_tlb_vppn             (w_vppn),
+    .w_tlb_asid             (w_asid),
+    .w_tlb_g                (w_g),
+    .w_tlb_ppn0             (w_ppn0),
+    .w_tlb_plv0             (w_plv0),
+    .w_tlb_mat0             (w_mat0),
+    .w_tlb_d0               (w_d0),
+    .w_tlb_v0               (w_v0),
+    .w_tlb_ppn1             (w_ppn1),
+    .w_tlb_plv1             (w_plv1),
+    .w_tlb_mat1             (w_mat1),
+    .w_tlb_d1               (w_d1),
+    .w_tlb_v1               (w_v1),
+
+    .csr_crmd_rvalue        (csr_crmd_rvalue),
+    .csr_asid_rvalue        (csr_asid_rvalue),
+    .csr_dmw0_rvalue        (csr_dmw0_rvalue),
+    .csr_dmw1_rvalue        (csr_dmw1_rvalue)
 );
 
 
 tlb #(.TLBNUM(16)) u_tlb(
-    .clk        (clk),
-    
-    .s0_vppn    (s0_vppn),
-    .s0_va_bit12(s0_va_bit12),
-    .s0_asid    (s0_asid),
-    .s0_found   (s0_found),
-    .s0_index   (s0_index),
-    .s0_ppn     (s0_ppn),
-    .s0_ps      (s0_ps),
-    .s0_plv     (s0_plv),
-    .s0_mat     (s0_mat),
-    .s0_d       (s0_d),
-    .s0_v       (s0_v),
-
-    .s1_vppn    (s1_vppn),
-    .s1_va_bit12(s1_va_bit12),
-    .s1_asid    (s1_asid),
-    .s1_found   (s1_found),
-    .s1_index   (s1_index),
-    .s1_ppn     (s1_ppn),
-    .s1_ps      (s1_ps),
-    .s1_plv     (s1_plv),
-    .s1_mat     (s1_mat),
-    .s1_d       (s1_d),
-    .s1_v       (s1_v),
-
-    .invtlb_op  (invtlb_op),
-    .invtlb_valid(invtlb_valid),
+    .clk                    (clk),
+
+    .s0_vppn                (s0_vppn),
+    .s0_va_bit12            (s0_va_bit12),
+    .s0_asid                (s0_asid),
+    .s0_found               (s0_found),
+    .s0_index               (s0_index),
+    .s0_ppn                 (s0_ppn),
+    .s0_ps                  (s0_ps),
+    .s0_plv                 (s0_plv),
+    .s0_mat                 (s0_mat),
+    .s0_d                   (s0_d),
+    .s0_v                   (s0_v),
+
+    .s1_vppn                (s1_vppn),
+    .s1_va_bit12            (s1_va_bit12),
+    .s1_asid                (s1_asid),
+    .s1_found               (s1_found),
+    .s1_index               (s1_index),
+    .s1_ppn                 (s1_ppn),
+    .s1_ps                  (s1_ps),
+    .s1_plv                 (s1_plv),
+    .s1_mat                 (s1_mat),
+    .s1_d                   (s1_d),
+    .s1_v                   (s1_v),
+
+    .invtlb_op              (invtlb_op),
+    .invtlb_valid           (invtlb_valid),
     
-    .we         (we),
-    .w_index    (w_index),
-    .w_e        (w_e),
-    .w_vppn     (w_vppn),
-    .w_ps       (w_ps),
-    .w_asid     (w_asid),
-    .w_g        (w_g),
-
-    .w_ppn0     (w_ppn0),
-    .w_plv0     (w_plv0),
-    .w_mat0     (w_mat0),
-    .w_d0       (w_d0),
-    .w_v0       (w_v0),
-
-    .w_ppn1     (w_ppn1),
-    .w_plv1     (w_plv1),
-    .w_mat1     (w_mat1),
-    .w_d1       (w_d1),
-    .w_v1       (w_v1),
-
-    .r_index    (r_index),
-    .r_e        (r_e),
-    .r_vppn     (r_vppn),
-    .r_ps       (r_ps),
-    .r_asid     (r_asid),
-    .r_g        (r_g),
-
-    .r_ppn0     (r_ppn0),
-    .r_plv0     (r_plv0),
-    .r_mat0     (r_mat0),
-    .r_d0       (r_d0),
-    .r_v0       (r_v0),
-
-    .r_ppn1     (r_ppn1),
-    .r_plv1     (r_plv1),
-    .r_mat1     (r_mat1),
-    .r_d1       (r_d1),
-    .r_v1       (r_v1)
+    .we                     (we),
+    .w_index                (w_index),
+    .w_e                    (w_e),
+    .w_vppn                 (w_vppn),
+    .w_ps                   (w_ps),
+    .w_asid                 (w_asid),
+    .w_g                    (w_g),
+            
+    .w_ppn0                 (w_ppn0),
+    .w_plv0                 (w_plv0),
+    .w_mat0                 (w_mat0),
+    .w_d0                   (w_d0),
+    .w_v0                   (w_v0),
+            
+    .w_ppn1                 (w_ppn1),
+    .w_plv1                 (w_plv1),
+    .w_mat1                 (w_mat1),
+    .w_d1                   (w_d1),
+    .w_v1                   (w_v1),
+            
+    .r_index                (r_index),
+    .r_e                    (r_e),
+    .r_vppn                 (r_vppn),
+    .r_ps                   (r_ps),
+    .r_asid                 (r_asid),
+    .r_g                    (r_g),
+            
+    .r_ppn0                 (r_ppn0),
+    .r_plv0                 (r_plv0),
+    .r_mat0                 (r_mat0),
+    .r_d0                   (r_d0),
+    .r_v0                   (r_v0),
+            
+    .r_ppn1                 (r_ppn1),
+    .r_plv1                 (r_plv1),
+    .r_mat1                 (r_mat1),
+    .r_d1                   (r_d1),
+    .r_v1                   (r_v1)
 );
 
 endmodule
\ No newline at end of file
diff --git a/mycpu_top.v b/mycpu_top.v
index 3e1998f..43560a7 100644
--- a/mycpu_top.v
+++ b/mycpu_top.v
@@ -1,59 +1,59 @@
 `include "BUS_LEN.vh"
 module mycpu_top(
-    input         aclk   ,
-    input         aresetn,
- 
-    // ar 
-    output [ 3:0] arid   , // master -> slave
-    output [31:0] araddr , // master -> slave
-    output [ 7:0] arlen  , // master -> slave, 8'b0
-    output [ 2:0] arsize , // master -> slave
-    output [ 1:0] arburst, // master -> slave, 2'b1
-    output [ 1:0] arlock , // master -> slave, 2'b0
-    output [ 3:0] arcache, // master -> slave, 4'b0
-    output [ 2:0] arprot , // master -> slave, 3'b0
-    output        arvalid, // master -> slave
-    input         arready, // slave  -> master
-
-    // r
-    input  [ 3:0] rid    , // slave  -> master
-    input  [31:0] rdata  , // slave  -> master
-    input  [ 1:0] rresp  , // slave  -> master, ignore
-    input         rlast  , // slave  -> master, ignore
-    input         rvalid , // slave  -> master
-    output        rready , // master -> slave
-
-    // aw
-    output [ 3:0] awid   , // master -> slave, 4'b1
-    output [31:0] awaddr , // master -> slave
-    output [ 7:0] awlen  , // master -> slave, 8'b0
-    output [ 2:0] awsize , // master -> slave
-    output [ 1:0] awburst, // master -> slave, 2'b1
-    output [ 1:0] awlock , // master -> slave, 2'b0
-    output [ 3:0] awcache, // master -> slave, 4'b0
-    output [ 2:0] awprot , // master -> slave, 3'b0
-    output        awvalid, // master -> slave
-    input         awready, // slave  -> master
-
-    // w
-    output [ 3:0] wid    , // master -> slave, 4'b1
-    output [31:0] wdata  , // master -> slave
-    output [ 3:0] wstrb  , // master -> slave
-    output        wlast  , // master -> slave, 1'b1
-    output        wvalid , // master -> slave
-    input         wready , // slave  -> master
-
-    // b
-    input  [ 3:0] bid    , // slave  -> master, ignore
-    input  [ 1:0] bresp  , // slave  -> master, ignore
-    input         bvalid , // slave  -> master
-    output        bready , // master -> slave
+    input                       aclk   ,
+    input                       aresetn,
+
+    // ar               
+    output [ 3:0]               arid   , // master -> slave
+    output [31:0]               araddr , // master -> slave
+    output [ 7:0]               arlen  , // master -> slave, 8'b0
+    output [ 2:0]               arsize , // master -> slave
+    output [ 1:0]               arburst, // master -> slave, 2'b1
+    output [ 1:0]               arlock , // master -> slave, 2'b0
+    output [ 3:0]               arcache, // master -> slave, 4'b0
+    output [ 2:0]               arprot , // master -> slave, 3'b0
+    output                      arvalid, // master -> slave
+    input                       arready, // slave  -> master
+
+    // r                
+    input  [ 3:0]               rid    , // slave  -> master
+    input  [31:0]               rdata  , // slave  -> master
+    input  [ 1:0]               rresp  , // slave  -> master, ignore
+    input                       rlast  , // slave  -> master, ignore
+    input                       rvalid , // slave  -> master
+    output                      rready , // master -> slave
+
+    // aw               
+    output [ 3:0]               awid   , // master -> slave, 4'b1
+    output [31:0]               awaddr , // master -> slave
+    output [ 7:0]               awlen  , // master -> slave, 8'b0
+    output [ 2:0]               awsize , // master -> slave
+    output [ 1:0]               awburst, // master -> slave, 2'b1
+    output [ 1:0]               awlock , // master -> slave, 2'b0
+    output [ 3:0]               awcache, // master -> slave, 4'b0
+    output [ 2:0]               awprot , // master -> slave, 3'b0
+    output                      awvalid, // master -> slave
+    input                       awready, // slave  -> master
+
+    // w                
+    output [ 3:0]               wid    , // master -> slave, 4'b1
+    output [31:0]               wdata  , // master -> slave
+    output [ 3:0]               wstrb  , // master -> slave
+    output                      wlast  , // master -> slave, 1'b1
+    output                      wvalid , // master -> slave
+    input                       wready , // slave  -> master
+
+    // b                
+    input  [ 3:0]               bid    , // slave  -> master, ignore
+    input  [ 1:0]               bresp  , // slave  -> master, ignore
+    input                       bvalid , // slave  -> master
+    output                      bready , // master -> slave
     
     // trace debug interface
-    output [31:0] debug_wb_pc      ,
-    output [ 3:0] debug_wb_rf_we  ,
-    output [ 4:0] debug_wb_rf_wnum ,
-    output [31:0] debug_wb_rf_wdata
+    output [31:0]               debug_wb_pc      ,
+    output [ 3:0]               debug_wb_rf_we  ,
+    output [ 4:0]               debug_wb_rf_wnum ,
+    output [31:0]               debug_wb_rf_wdata
 );
 
 // inst sram interface    
@@ -103,7 +103,7 @@ mycpu_core u_mycpu_core(
     .data_sram_data_ok (data_sram_data_ok),
      
     .debug_wb_pc       (debug_wb_pc      ),
-    .debug_wb_rf_we   (debug_wb_rf_we  ),
+    .debug_wb_rf_we    (debug_wb_rf_we  ),
     .debug_wb_rf_wnum  (debug_wb_rf_wnum ),
     .debug_wb_rf_wdata (debug_wb_rf_wdata)
 );
@@ -153,7 +153,7 @@ transfer_bridge u_transfer_bridge(
     .bvalid            (bvalid           ),
     .bready            (bready           ),
 
-    .inst_sram_en     (inst_sram_req    ),
+    .inst_sram_en      (inst_sram_req    ),
     .inst_sram_wr      (inst_sram_wr     ),
     .inst_sram_size    (inst_sram_size   ),
     .inst_sram_wstrb   (inst_sram_wstrb  ),
@@ -163,7 +163,7 @@ transfer_bridge u_transfer_bridge(
     .inst_sram_addr_ok (inst_sram_addr_ok),
     .inst_sram_data_ok (inst_sram_data_ok),
 
-    .data_sram_en     (data_sram_req    ),
+    .data_sram_en      (data_sram_req    ),
     .data_sram_wr      (data_sram_wr     ),
     .data_sram_wstrb   (data_sram_wstrb  ),
     .data_sram_size    (data_sram_size   ),
diff --git a/preIFstage.v b/preIFstage.v
deleted file mode 100644
index 8232344..0000000
--- a/preIFstage.v
+++ /dev/null
@@ -1,88 +0,0 @@
-`include "BUS_LEN.vh"
-module preIFstage(
-    input wire                          clk,
-    input wire                          resetn,
-    input wire                          reset,
-
-    // interface with SRAM
-    output wire                         inst_sram_en,
-    output wire                         inst_sram_wr,
-    output wire [ 3:0]                  inst_sram_we,
-    output wire [ 1:0]                  inst_sram_size,
-    output wire [31:0]                  inst_sram_addr,
-    output wire [31:0]                  inst_sram_wdata,
-    input  wire [31:0]                  inst_sram_rdata,
-    input  wire                         inst_sram_addr_ok,
-
-    // interface between preIF to IF
-    input wire                          fs_allowin,
-    input wire [`BR_BUS-1:0]            br_zip,
-    input wire [`BR_BUS-1:0]            fs_br_zip,
-    input wire                          fs_reflush;
-    output wire                         to_fs_valid,
-    output wire                         pfs_ready_go,
-
-    // interface with CSR
-    input wire [31: 0]                  csr_ex_entry,
-    input wire [31: 0]                  csr_ertn_entry,
-
-    input wire                          wb_ex,          // exception in WB
-    input wire                          ertn_flush,     // ertn in WB
-    input wire                          fs_reflush,     // syscall in WB
-    input wire [IF2PFS_CSR_BUS-1:0]     fs2pfs_bus, 
-)
-reg pfs_valid;
-wire to_fs_valid;
-wire pfs_ready_go;
-wire [31:0] nextpc;
-
-wire br_stall;//
-wire br_taken;
-wire [31:0] br_target;
-wire fs_br_stall;
-wire fs_br_taken;
-wire [31:0] fs_br_target;
-assign {br_stall, br_taken, br_target} = br_zip;
-assign {fs_br_stall, fs_br_taken, fs_br_target} = fs_br_zip;
-always @(posedge clk) begin
-  if (~resetn  ) begin
-    pfs_valid <= 1'b0;
-  end
-  else begin
-    pfs_valid <= 1'b1;
-  end
-end
-
-assign to_fs_valid = pfs_valid & pfs_ready_go;
-//TODO
-assign pfs_ready_go = inst_sram_en && inst_sram_addr_ok&~(pfs_reflush | fs_reflush | br_taken &~br_stall | br_stall);
-
-assign inst_sram_en = fs_allowin & pfs_valid & ~pfs_reflush ;
-assign inst_sram_wr = 1'b0;
-assign inst_sram_wr       = 1'b0;
-assign inst_sram_we       = 4'b0;
-assign inst_sram_size     = 2'b10;
-assign inst_sram_wstrb    = 4'b0;
-assign inst_sram_wdata    = 32'b0;
-assign inst_sram_addr     = nextpc;
-
-reg pfs_reflush;
-always @(posedge clk) begin
-    if(~resetn)
-        pfs_reflush <= 1'b0;
-    else if(inst_sram_en && (fs_reflush | br_taken &~ br_stall | (br_stall | fs_br_stall)&inst_sram_addr_ok))
-        pfs_reflush <= 1'b1;
-    else if(inst_sram_data_ok)
-        pfs_reflush <= 1'b0;
-end
-
-wire[31:0] seq_pc;
-assign nextpc  =  wb_ex? csr_ex_entry:   //the nextpc is updated in these cases
-                  fs_ex_valid? fs_ex_entry:
-                  fs_ertn_valid? fs_ertn_entry:
-                  ertn_flush? csr_ertn_entry:
-                  fs_br_taken? fs_br_target:
-                  br_taken & ~br_stall ? br_target : seq_pc;
-
-
-endmodule
\ No newline at end of file
diff --git a/regfile.v b/regfile.v
index 3f83aac..68b4747 100644
--- a/regfile.v
+++ b/regfile.v
@@ -1,15 +1,15 @@
 module regfile(
-    input  wire        clk,
-    // READ PORT 1
-    input  wire [ 4:0] raddr1,
-    output wire [31:0] rdata1,
-    // READ PORT 2
-    input  wire [ 4:0] raddr2,
-    output wire [31:0] rdata2,
-    // WRITE PORT
-    input  wire        we,       //write enable, HIGH valid
-    input  wire [ 4:0] waddr,
-    input  wire [31:0] wdata
+    input  wire                     clk,
+    // READ PORT 1              
+    input  wire [ 4:0]              raddr1,
+    output wire [31:0]              rdata1,
+    // READ PORT 2              
+    input  wire [ 4:0]              raddr2,
+    output wire [31:0]              rdata2,
+    // WRITE PORT               
+    input  wire                     we,       //write enable, HIGH valid
+    input  wire [ 4:0]              waddr,
+    input  wire [31:0]              wdata
 );
 reg [31:0] rf[31:0];
 
diff --git a/tlb.v b/tlb.v
index ba6c850..7834c6e 100644
--- a/tlb.v
+++ b/tlb.v
@@ -6,74 +6,74 @@ module tlb
     input wire clk,
 
     // search port 0 (for fetch)
-    input  wire [              18:0] s0_vppn,
-    input  wire                      s0_va_bit12,
-    input  wire [               9:0] s0_asid,
-    output wire                      s0_found,
-    output wire [$clog2(TLBNUM)-1:0] s0_index,//clog2 is a system function, return the ceil(log2(TLBNUM))
-    output wire [              19:0] s0_ppn,
-    output wire [               5:0] s0_ps,
-    output wire [               1:0] s0_plv,
-    output wire [               1:0] s0_mat,
-    output wire                      s0_d,
-    output wire                      s0_v,
+    input  wire [              18:0]                s0_vppn,
+    input  wire                                     s0_va_bit12,
+    input  wire [               9:0]                s0_asid,
+    output wire                                     s0_found,
+    output wire [$clog2(TLBNUM)-1:0]                s0_index,//clog2 is a system function, return the ceil(log2(TLBNUM))
+    output wire [              19:0]                s0_ppn,
+    output wire [               5:0]                s0_ps,
+    output wire [               1:0]                s0_plv,
+    output wire [               1:0]                s0_mat,
+    output wire                                     s0_d,
+    output wire                                     s0_v,
 
     // search port 1 (for load/store)
-    input  wire [              18:0] s1_vppn,
-    input  wire                      s1_va_bit12,
-    input  wire [               9:0] s1_asid,
-    output wire                      s1_found,
-    output wire [$clog2(TLBNUM)-1:0] s1_index,
-    output wire [              19:0] s1_ppn,
-    output wire [               5:0] s1_ps,
-    output wire [               1:0] s1_plv,
-    output wire [               1:0] s1_mat,
-    output wire                      s1_d,
-    output wire                      s1_v,
+    input  wire [              18:0]                s1_vppn,
+    input  wire                                     s1_va_bit12,
+    input  wire [               9:0]                s1_asid,
+    output wire                                     s1_found,
+    output wire [$clog2(TLBNUM)-1:0]                s1_index,
+    output wire [              19:0]                s1_ppn,
+    output wire [               5:0]                s1_ps,
+    output wire [               1:0]                s1_plv,
+    output wire [               1:0]                s1_mat,
+    output wire                                     s1_d,
+    output wire                                     s1_v,
 
     // invtlb opcode
-    input  wire                      invtlb_valid,
-    input  wire [               4:0] invtlb_op,
-
-    // write port
-    input  wire                      we,
-    input  wire [$clog2(TLBNUM)-1:0] w_index,
-    input  wire                      w_e,
-    input  wire [              18:0] w_vppn,
-    input  wire [               5:0] w_ps,
-    input  wire [               9:0] w_asid,
-    input  wire                      w_g,
-
-    input  wire [              19:0] w_ppn0,
-    input  wire [               1:0] w_plv0,
-    input  wire [               1:0] w_mat0,
-    input  wire                      w_d0,
-    input  wire                      w_v0,
-
-    input  wire [              19:0] w_ppn1,
-    input  wire [               1:0] w_plv1,
-    input  wire [               1:0] w_mat1,
-    input  wire                      w_d1,
-    input  wire                      w_v1,
-
-    // read port
-    input  wire [$clog2(TLBNUM)-1:0] r_index,
-    output wire                      r_e,
-    output wire [              18:0] r_vppn,
-    output wire [               5:0] r_ps,
-    output wire [               9:0] r_asid,
-    output wire                      r_g,
-
-    output wire [              19:0] r_ppn0,
-    output wire [               1:0] r_plv0,
-    output wire [               1:0] r_mat0,
-    output wire                      r_d0,
-    output wire                      r_v0,
-    output wire [              19:0] r_ppn1,
-    output wire [               1:0] r_plv1,
-    output wire [               1:0] r_mat1,
-    output wire                      r_d1,
-    output wire                      r_v1
+    input  wire                                     invtlb_valid,
+    input  wire [               4:0]                invtlb_op,
+                
+    // write port               
+    input  wire                                     we,
+    input  wire [$clog2(TLBNUM)-1:0]                w_index,
+    input  wire                                     w_e,
+    input  wire [              18:0]                w_vppn,
+    input  wire [               5:0]                w_ps,
+    input  wire [               9:0]                w_asid,
+    input  wire                                     w_g,
+                
+    input  wire [              19:0]                w_ppn0,
+    input  wire [               1:0]                w_plv0,
+    input  wire [               1:0]                w_mat0,
+    input  wire                                     w_d0,
+    input  wire                                     w_v0,
+                
+    input  wire [              19:0]                w_ppn1,
+    input  wire [               1:0]                w_plv1,
+    input  wire [               1:0]                w_mat1,
+    input  wire                                     w_d1,
+    input  wire                                     w_v1,
+                
+    // read port                
+    input  wire [$clog2(TLBNUM)-1:0]                r_index,
+    output wire                                     r_e,
+    output wire [              18:0]                r_vppn,
+    output wire [               5:0]                r_ps,
+    output wire [               9:0]                r_asid,
+    output wire                                     r_g,
+                
+    output wire [              19:0]                r_ppn0,
+    output wire [               1:0]                r_plv0,
+    output wire [               1:0]                r_mat0,
+    output wire                                     r_d0,
+    output wire                                     r_v0,
+    output wire [              19:0]                r_ppn1,
+    output wire [               1:0]                r_plv1,
+    output wire [               1:0]                r_mat1,
+    output wire                                     r_d1,
+    output wire                                     r_v1
 );
 
 reg [TLBNUM-1:0] tlb_e;
diff --git a/transfer_bridge.v b/transfer_bridge.v
index 28a87f7..f8c13e0 100644
--- a/transfer_bridge.v
+++ b/transfer_bridge.v
@@ -1,86 +1,77 @@
 `include "BUS_LEN.vh"
 module transfer_bridge(
-    input wire         clk    ,
-    input wire         resetn ,
+    input wire                      clk    ,
+    input wire                      resetn ,
  
     // ar 
-    output wire    [ 3:0] arid   , // master -> slave
-    output wire    [31:0] araddr , // master -> slave
-    output wire    [ 7:0] arlen  , // master -> slave, 8'b0
-    output wire    [ 2:0] arsize , // master -> slave
-    output wire    [ 1:0] arburst, // master -> slave, 2'b1
-    output wire    [ 1:0] arlock , // master -> slave, 2'b0
-    output wire    [ 3:0] arcache, // master -> slave, 4'b0
-    output wire    [ 2:0] arprot , // master -> slave, 3'b0
-    output wire           arvalid, // master -> slave
-    input  wire           arready, // slave  -> master
-
-    // r
-    input  wire    [ 3:0] rid   , // slave  -> master
-    input  wire    [31:0] rdata , // slave  -> master
-    input  wire    [ 1:0] rresp , // slave  -> master, ignore
-    input  wire           rlast , // slave  -> master, ignore
-    input  wire           rvalid, // slave  -> master
-    output wire           rready, // master -> slave
-
-    // aw
-    output wire    [ 3:0] awid   , // master -> slave, 4'b1
-    output wire    [31:0] awaddr , // master -> slave
-    output wire    [ 7:0] awlen  , // master -> slave, 8'b0
-    output wire    [ 2:0] awsize , // master -> slave
-    output wire    [ 1:0] awburst, // master -> slave, 2'b1
-    output wire    [ 1:0] awlock , // master -> slave, 2'b0
-    output wire    [ 3:0] awcache, // master -> slave, 4'b0
-    output wire    [ 2:0] awprot , // master -> slave, 3'b0
-    output wire           awvalid, // master -> slave
-    input  wire           awready, // slave  -> master
+    output wire    [ 3:0]           arid   , // master -> slave
+    output wire    [31:0]           araddr , // master -> slave
+    output wire    [ 7:0]           arlen  , // master -> slave, 8'b0
+    output wire    [ 2:0]           arsize , // master -> slave
+    output wire    [ 1:0]           arburst, // master -> slave, 2'b1
+    output wire    [ 1:0]           arlock , // master -> slave, 2'b0
+    output wire    [ 3:0]           arcache, // master -> slave, 4'b0
+    output wire    [ 2:0]           arprot , // master -> slave, 3'b0
+    output wire                     arvalid, // master -> slave
+    input  wire                     arready, // slave  -> master
+
+    // r            
+    input  wire    [ 3:0]           rid   , // slave  -> master
+    input  wire    [31:0]           rdata , // slave  -> master
+    input  wire    [ 1:0]           rresp , // slave  -> master, ignore
+    input  wire                     rlast , // slave  -> master, ignore
+    input  wire                     rvalid, // slave  -> master
+    output wire                     rready, // master -> slave
+
+    // aw           
+    output wire    [ 3:0]           awid   , // master -> slave, 4'b1
+    output wire    [31:0]           awaddr , // master -> slave
+    output wire    [ 7:0]           awlen  , // master -> slave, 8'b0
+    output wire    [ 2:0]           awsize , // master -> slave
+    output wire    [ 1:0]           awburst, // master -> slave, 2'b1
+    output wire    [ 1:0]           awlock , // master -> slave, 2'b0
+    output wire    [ 3:0]           awcache, // master -> slave, 4'b0
+    output wire    [ 2:0]           awprot , // master -> slave, 3'b0
+    output wire                     awvalid, // master -> slave
+    input  wire                     awready, // slave  -> master
 
     // w
-    output wire    [ 3:0] wid   , // master -> slave, 4'b1
-    output wire    [31:0] wdata , // master -> slave
-    output wire    [ 3:0] wstrb , // master -> slave
-    output wire           wlast , // master -> slave, 1'b1
-    output wire           wvalid, // master -> slave
-    input  wire           wready, // slave  -> master
+    output wire    [ 3:0]           wid   , // master -> slave, 4'b1
+    output wire    [31:0]           wdata , // master -> slave
+    output wire    [ 3:0]           wstrb , // master -> slave
+    output wire                     wlast , // master -> slave, 1'b1
+    output wire                     wvalid, // master -> slave
+    input  wire                     wready, // slave  -> master
 
     // b
-    input  wire   [ 3:0] bid   , // slave  -> master, ignore
-    input  wire   [ 1:0] bresp , // slave  -> master, ignore
-    input  wire          bvalid, // slave  -> master
-    output wire          bready, // master -> slave
+    input  wire   [ 3:0]            bid   , // slave  -> master, ignore
+    input  wire   [ 1:0]            bresp , // slave  -> master, ignore
+    input  wire                     bvalid, // slave  -> master
+    output wire                     bready, // master -> slave
 
     // inst sram interface    
-    input  wire          inst_sram_en    ,
-    input  wire          inst_sram_wr     ,
-    input  wire   [ 1:0] inst_sram_size   ,
-    input  wire   [ 3:0] inst_sram_wstrb  ,
-    input  wire   [31:0] inst_sram_addr   ,
-    input  wire   [31:0] inst_sram_wdata  ,
-    output wire   [31:0] inst_sram_rdata  ,
-    output wire          inst_sram_addr_ok,
-    output wire          inst_sram_data_ok,
+    input  wire                     inst_sram_en     ,
+    input  wire                     inst_sram_wr     ,
+    input  wire   [ 1:0]            inst_sram_size   ,
+    input  wire   [ 3:0]            inst_sram_wstrb  ,
+    input  wire   [31:0]            inst_sram_addr   ,
+    input  wire   [31:0]            inst_sram_wdata  ,
+    output wire   [31:0]            inst_sram_rdata  ,
+    output wire                     inst_sram_addr_ok,
+    output wire                     inst_sram_data_ok,
     
     // data sram interface
-    input  wire          data_sram_en    ,
-    input  wire          data_sram_wr     ,
-    input  wire   [ 3:0] data_sram_wstrb  ,
-    input  wire   [ 1:0] data_sram_size   , 
-    input  wire   [31:0] data_sram_addr   ,
-    input  wire   [31:0] data_sram_wdata  ,
-    output wire   [31:0] data_sram_rdata  ,
-    output wire          data_sram_addr_ok,
-    output wire          data_sram_data_ok
+    input  wire                     data_sram_en     ,
+    input  wire                     data_sram_wr     ,
+    input  wire   [ 3:0]            data_sram_wstrb  ,
+    input  wire   [ 1:0]            data_sram_size   , 
+    input  wire   [31:0]            data_sram_addr   ,
+    input  wire   [31:0]            data_sram_wdata  ,
+    output wire   [31:0]            data_sram_rdata  ,
+    output wire                     data_sram_addr_ok,
+    output wire                     data_sram_data_ok
 );
 
-
-
-
-
-
-
-
-
-
     wire reset;
     assign reset = ~resetn;
 
@@ -130,15 +121,6 @@ module transfer_bridge(
     reg bready_reg;
     assign bready = bready_reg;
 
-
-
-
-
-
-
-
-
-
     // state machine
 
     parameter READ_REQ_RST          = 5'b00001; // 1
-- 
2.39.2.windows.1

